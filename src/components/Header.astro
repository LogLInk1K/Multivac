---
import HeaderLink from './HeaderLink.astro';
import ThemeToggle from './ThemeToggle.astro';
import SearchModal from './SearchModal.astro';
---

<header 
    id="main-header"
    class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 ease-in-out py-0"
>
    <nav 
        id="nav-container"
        class="relative max-w-[calc(100%-40px)] md:max-w-[calc(100%-40px)] xl:max-w-[1300px] mx-auto flex items-center transition-all duration-500 ease-in-out border-b border-transparent px-4 sm:px-6 lg:px-8 py-4"
    >
		<div
			id="nav-bg"
			class="absolute z-[-1] transition-all duration-500 ease-in-out
          		 bg-white/80 dark:bg-black/70 opacity-0
          		   rounded-full shadow-lg backdrop-blur-md ring-1 ring-white/20
           		   top-2 bottom-2 left-0 right-0"
		></div>
        <div class="flex-1 shrink-0">
            <h2 class="text-2xl font-bold whitespace-nowrap">
                <a href="/" class="text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-colors">
                    Log
                </a>
            </h2>
        </div>

        <div class="hidden md:flex items-center px-4 relative">
            <div id="nav-links" class="flex items-center space-x-8 transition-all duration-300 translate-y-0">
                <HeaderLink href="/">首页</HeaderLink>
                <HeaderLink href="/archives">文稿</HeaderLink>
                <HeaderLink href="/about">关于</HeaderLink>
            </div>
            <h1 id="page-title" class="absolute left-1/2 -translate-x-1/2 text-lg font-bold text-text-light dark:text-text-dark opacity-0 transition-all duration-300 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px] translate-y-2 cursor-pointer hover:text-primary-light dark:hover:text-primary-dark" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"></h1>
        </div>

        <div class="flex-1 flex justify-end items-center shrink-0">
            <button 
                onclick="window.openSearchModal()" 
                class="text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-colors focus:outline-none mr-2"
                aria-label="搜索"
            >
                <svg 
                    class="w-6 h-6" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                >
                    <path 
                        stroke-linecap="round" 
                        stroke-linejoin="round" 
                        stroke-width="2" 
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    ></path>
                </svg>
            </button>
            <div id="theme-toggle-container" class="flex items-center mr-0 transition-all duration-300">
                <ThemeToggle />
            </div>
            <div 
                id="scroll-counter"
                class="h-7 rounded-full bg-black dark:bg-white text-white dark:text-black text-sm font-mono flex items-center justify-center transition-all duration-300 cursor-pointer hover:scale-110 active:scale-95 opacity-0 w-0 overflow-hidden"
                onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
            >
                <span id="scroll-value">0</span>
                <span 
                    id="scroll-arrow"
                    class="hidden text-sm font-sans whitespace-nowrap"
                >
                    返回顶部
                </span>
            </div>
        </div>
    </nav>
</header>

<SearchModal />

<script>
    // 将所有逻辑封装在 init 函数中
    function initHeader() {
        const nav = document.getElementById('nav-container');
        const navBg = document.getElementById('nav-bg');
        const scrollCounter = document.getElementById('scroll-counter');
        const scrollValue = document.getElementById('scroll-value');
        const scrollArrow = document.getElementById('scroll-arrow');
        const themeToggleContainer = document.getElementById('theme-toggle-container');
        const navLinks = document.getElementById('nav-links');
        const pageTitle = document.getElementById('page-title');

        if (!nav) return; // 容错处理

        let lastScrollY = window.scrollY;

        function updateHeader() {
            const scrollY = window.scrollY;
            const scrollDirection = scrollY > lastScrollY ? 'down' : 'up';
            lastScrollY = scrollY;
            
            if (scrollY > 20) {
                nav?.classList.remove('max-w-[calc(100%-40px)]', 'md:max-w-[calc(100%-40px)]', 'xl:max-w-[1300px]', 'px-4', 'sm:px-6', 'lg:px-8');
                nav?.classList.add('max-w-[calc(100%-80px)]', 'md:max-w-[500px]', 'xl:max-w-[600px]', 'px-4');
                navBg?.classList.replace('opacity-0', 'opacity-100');
                
                if (scrollDirection === 'down') {
                    navLinks?.classList.add('opacity-0', 'pointer-events-none', '-translate-y-2');
                    navLinks?.classList.remove('translate-y-0');
                    pageTitle?.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
                    pageTitle?.classList.add('translate-y-0');
                } else {
                    navLinks?.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-2');
                    navLinks?.classList.add('translate-y-0');
                    pageTitle?.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
                    pageTitle?.classList.remove('translate-y-0');
                }
            } else {
                nav?.classList.add('max-w-[calc(100%-40px)]', 'md:max-w-[calc(100%-40px)]', 'xl:max-w-[1300px]', 'px-4', 'sm:px-6', 'lg:px-8');
                nav?.classList.remove('max-w-[calc(100%-80px)]', 'md:max-w-[500px]', 'xl:max-w-[600px]', 'px-4');
                navBg?.classList.replace('opacity-100', 'opacity-0');
                navLinks?.classList.remove('opacity-0', 'pointer-events-none');
                pageTitle?.classList.add('opacity-0', 'pointer-events-none');
            }

            if (scrollCounter && scrollValue && scrollArrow && themeToggleContainer) {
                const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = scrollHeight > 0 ? scrollY / scrollHeight : 0;
                const displayValue = Math.floor(scrollPercent * 99);
                
                if (scrollY > 20) {
                    // 显示滚动计数器，同时调整主题切换按钮位置
                    scrollCounter.classList.remove('opacity-0', 'w-0');
                    scrollCounter.classList.add('opacity-100', 'w-7');
                    themeToggleContainer.classList.remove('mr-0');
                    themeToggleContainer.classList.add('mr-2');
                    
                    if (displayValue >= 90) {
                        scrollValue.classList.add('hidden');
                        scrollArrow.classList.remove('hidden');
                        scrollCounter.classList.remove('w-7');
                        scrollCounter.classList.add('w-20', 'px-2');
                    } else {
                        scrollValue.classList.remove('hidden');
                        scrollArrow.classList.add('hidden');
                        scrollCounter.classList.remove('w-20', 'px-2');
                        scrollCounter.classList.add('w-7');
                        scrollValue.textContent = displayValue.toString();
                    }
                } else {
                    // 完全隐藏滚动计数器，让主题切换按钮占据其位置
                    scrollCounter.classList.add('opacity-0', 'w-0');
                    scrollCounter.classList.remove('opacity-100', 'w-7', 'w-20', 'px-2');
                    themeToggleContainer.classList.remove('mr-2');
                    themeToggleContainer.classList.add('mr-0');
                }
            }
        }

        function setPageTitle() {
            // 在 ClientRouter 下，document.title 需要一点时间同步，或者手动获取
            if (pageTitle) {
                pageTitle.textContent = document.title;
            }
        }

        // 监听滚动
        window.addEventListener('scroll', updateHeader);
        
        // 初始运行一次
        updateHeader();
        setPageTitle();

        // 【关键】由于 ClientRouter 不会刷新窗口，我们需要在离开页面时手动移除监听器
        // 否则跳转多次后会有多个监听器在后台跑，导致内存泄漏和卡顿
        document.addEventListener('astro:before-preparation', () => {
            window.removeEventListener('scroll', updateHeader);
        }, { once: true });
    }

    // 适配 ClientRouter：首次加载和后续每次跳转后都初始化
    initHeader();
    document.addEventListener('astro:page-load', initHeader);
</script>	