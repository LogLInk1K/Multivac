---
import HeaderLink from './HeaderLink.astro';
import ThemeToggle from './ThemeToggle.astro';
import SearchModal from './SearchModal.astro';
---

<header 
    id="main-header"
    class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 ease-in-out py-0"
>
    <nav 
        id="nav-container"
        class="relative max-w-[calc(100%-40px)] md:max-w-[calc(100%-40px)] xl:max-w-[1300px] mx-auto flex items-center transition-all duration-500 ease-in-out border-b border-transparent px-4 sm:px-6 lg:px-8 py-4"
    >
		<div
			id="nav-bg"
			class="absolute z-[-1] transition-all duration-500 ease-in-out
          		 bg-white/80 dark:bg-black/70 opacity-0
          		   rounded-full shadow-lg backdrop-blur-md ring-1 ring-white/20
           		   top-2 bottom-2 left-0 right-0"
		></div>
        <div class="flex-1 shrink-0 flex items-center">
            <button
                id="menu-trigger-btn"
                onclick="window.toggleMenuPanel()"
                class="group relative text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-colors focus:outline-none mr-4"
                aria-label="菜单"
            >
                <svg
                    class="w-6 h-6 transition-all duration-300 group-hover:scale-75"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
                    <div class="bg-primary-light dark:bg-primary-dark rounded-full px-1 py-1">
                        <svg class="w-6 h-6 text-white dark:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"
                            ></path>
                        </svg>
                    </div>
                </div>
            </button>
            <h2 class="text-[22px] font-plus-jakarta font-extrabold whitespace-nowrap">
                <a href="/" class="group relative text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-all duration-300 inline-block">
                    <span class="inline-block transition-all duration-300 group-hover:opacity-0 group-hover:scale-75">LOG</span>
                    <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
                        <div class="bg-primary-light dark:bg-primary-dark rounded-full px-4 py-1">
                            <svg class="w-6 h-6 text-white dark:text-black" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                </a>
            </h2>
        </div>

        <div class="hidden md:flex items-center px-4 relative">
            <div id="nav-links" class="flex items-center space-x-8 transition-all duration-300 translate-y-0">
                <HeaderLink href="/">首页</HeaderLink>
                <HeaderLink href="/archives">文稿</HeaderLink>
                <HeaderLink href="/about">关于</HeaderLink>
            </div>
            <h1 id="page-title" class="absolute left-1/2 -translate-x-1/2 text-lg font-bold text-text-light dark:text-text-dark opacity-0 transition-all duration-300 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px] translate-y-2 cursor-pointer hover:text-primary-light dark:hover:text-primary-dark" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"></h1>
        </div>

        <div class="flex-1 flex justify-end items-center shrink-0">
            <button 
                onclick="window.openSearchModal()" 
                class="group relative text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-colors focus:outline-none mr-2"
                aria-label="搜索"
            >
                <svg 
                    class="w-6 h-6 transition-all duration-300 group-hover:scale-75" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                >
                    <path 
                        stroke-linecap="round" 
                        stroke-linejoin="round" 
                        stroke-width="2" 
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    ></path>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
                    <div class="bg-primary-light dark:bg-primary-dark rounded-full px-1 py-1">
                        <svg class="w-6 h-6 text-white dark:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path 
                                stroke-linecap="round" 
                                stroke-linejoin="round" 
                                stroke-width="2" 
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            ></path>
                        </svg>
                    </div>
                </div>
            </button>
            <div id="theme-toggle-container" class="flex items-center mr-0 transition-all duration-300">
                <ThemeToggle />
            </div>
            <div
                id="scroll-counter"
                class="inline-flex items-center justify-center h-7 rounded-full bg-black dark:bg-white text-white dark:text-black text-sm font-mono transition-all duration-300 ease-[cubic-bezier(0.34,1.56,0.64,1)] cursor-pointer hover:scale-105 active:scale-95 opacity-0 overflow-hidden mr-0"
                style="width: 1.75rem; transform: scale(0); transform-origin: center center; will-change: transform, opacity, margin-right;"
                onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
            >
                <span id="scroll-value" class="px-1.5 whitespace-nowrap">0</span>
                <span
                    id="scroll-arrow"
                    class="hidden px-2 text-sm font-sans whitespace-nowrap"
                >
                    返回顶部
                </span>
            </div>
        </div>

        <!-- 菜单面板（移到 nav-container 层级） -->
        <div id="menu-panel" class="absolute top-0 w-[320px] p-2 rounded-xl bg-white/80 dark:bg-black/70 backdrop-blur-md border border-white/20 dark:border-white/10 shadow-2xl opacity-0 scale-95 pointer-events-none transition-all duration-300 origin-top z-20" style="margin-top: 5.5rem;">
            <div class="grid grid-cols-2 gap-2">
                <!-- 菜单项 -->
                <a href="http://1k.ink/" target="_blank" rel="noopener noreferrer" class="relative flex items-center gap-3 px-4 py-3 rounded-lg group/item overflow-hidden">
                    <svg class="w-6 h-6 text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:scale-75 group-hover/item:opacity-0 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-base font-medium text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:opacity-0">主页</span>
                    <div class="absolute inset-0 opacity-0 scale-75 transition-all duration-300 group-hover/item:opacity-100 group-hover/item:scale-100 pointer-events-none">
                        <div class="bg-primary-light dark:bg-primary-dark rounded-lg absolute inset-0"></div>
                        <div class="absolute inset-0 flex items-center gap-3 px-4 py-3">
                            <svg class="w-6 h-6 text-white dark:text-black transition-all duration-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            <span class="text-base font-medium text-white dark:text-black transition-all duration-300">主页</span>
                        </div>
                    </div>
                </a>
                <a href="/" class="relative flex items-center gap-3 px-4 py-3 rounded-lg group/item overflow-hidden">
                    <svg class="w-6 h-6 text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:scale-75 group-hover/item:opacity-0 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-base font-medium text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:opacity-0">首页</span>
                    <div class="absolute inset-0 opacity-0 scale-75 transition-all duration-300 group-hover/item:opacity-100 group-hover/item:scale-100 pointer-events-none">
                        <div class="bg-primary-light dark:bg-primary-dark rounded-lg absolute inset-0"></div>
                        <div class="absolute inset-0 flex items-center gap-3 px-4 py-3">
                            <svg class="w-6 h-6 text-white dark:text-black transition-all duration-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-base font-medium text-white dark:text-black transition-all duration-300">首页</span>
                        </div>
                    </div>
                </a>
                <a href="/archives" class="relative flex items-center gap-3 px-4 py-3 rounded-lg group/item overflow-hidden">
                    <svg class="w-6 h-6 text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:scale-75 group-hover/item:opacity-0 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <span class="text-base font-medium text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:opacity-0">文稿</span>
                    <div class="absolute inset-0 opacity-0 scale-75 transition-all duration-300 group-hover/item:opacity-100 group-hover/item:scale-100 pointer-events-none">
                        <div class="bg-primary-light dark:bg-primary-dark rounded-lg absolute inset-0"></div>
                        <div class="absolute inset-0 flex items-center gap-3 px-4 py-3">
                            <svg class="w-6 h-6 text-white dark:text-black transition-all duration-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            <span class="text-base font-medium text-white dark:text-black transition-all duration-300">文稿</span>
                        </div>
                    </div>
                </a>
                <a href="/about" class="relative flex items-center gap-3 px-4 py-3 rounded-lg group/item overflow-hidden">
                    <svg class="w-6 h-6 text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:scale-75 group-hover/item:opacity-0 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-base font-medium text-text-light dark:text-text-dark transition-all duration-300 group-hover/item:opacity-0">关于</span>
                    <div class="absolute inset-0 opacity-0 scale-75 transition-all duration-300 group-hover/item:opacity-100 group-hover/item:scale-100 pointer-events-none">
                        <div class="bg-primary-light dark:bg-primary-dark rounded-lg absolute inset-0"></div>
                        <div class="absolute inset-0 flex items-center gap-3 px-4 py-3">
                            <svg class="w-6 h-6 text-white dark:text-black transition-all duration-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="text-base font-medium text-white dark:text-black transition-all duration-300">关于</span>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </nav>
</header>

<SearchModal />

<script>
    // 将所有逻辑封装在 init 函数中
    function initHeader() {
        const nav = document.getElementById('nav-container');
        const navBg = document.getElementById('nav-bg');
        const scrollCounter = document.getElementById('scroll-counter');
        const scrollValue = document.getElementById('scroll-value');
        const scrollArrow = document.getElementById('scroll-arrow');
        const themeToggleContainer = document.getElementById('theme-toggle-container');
        const navLinks = document.getElementById('nav-links');
        const pageTitle = document.getElementById('page-title');
        const menuTriggerBtn = document.getElementById('menu-trigger-btn');
        const menuPanel = document.getElementById('menu-panel');

        if (!nav) return; // 容错处理

        // 菜单面板逻辑（基于设备交互能力：hover设备用hover触发，触控设备用点击触发）
        if (menuTriggerBtn && menuPanel) {
            let hideTimeout: ReturnType<typeof setTimeout> | undefined;
            let isMenuOpen = false;

            // 检测设备是否支持hover
            const hasHover = window.matchMedia('(hover: hover)').matches;

            const showMenu = () => {
                clearTimeout(hideTimeout);
                const rect = menuTriggerBtn.getBoundingClientRect();
                const navRect = nav.getBoundingClientRect();

                // 计算面板位置：相对于 nav-container
                const leftPos = rect.left - navRect.left - 20;
                menuPanel.style.left = `${leftPos}px`;
                menuPanel.style.marginTop = '70px';
                menuPanel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                menuPanel.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                isMenuOpen = true;
            };

            const hideMenu = () => {
                menuPanel.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                menuPanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                isMenuOpen = false;
            };

            if (hasHover) {
                // 鼠标设备：hover触发
                menuTriggerBtn.addEventListener('mouseenter', showMenu);
                menuPanel.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
                menuTriggerBtn.addEventListener('mouseleave', () => {
                    hideTimeout = setTimeout(hideMenu, 100);
                });
                menuPanel.addEventListener('mouseleave', hideMenu);
            } else {
                // 触控设备：点击触发
                (window as any).toggleMenuPanel = () => {
                    if (isMenuOpen) {
                        hideMenu();
                    } else {
                        showMenu();
                    }
                };

                // 点击外部关闭面板
                document.addEventListener('click', (e) => {
                    if (isMenuOpen) {
                        if (!menuPanel.contains(e.target as Node) && !menuTriggerBtn.contains(e.target as Node)) {
                            hideMenu();
                        }
                    }
                });
            }
        }

        let lastScrollY = window.scrollY;

        function updateHeader() {
            const scrollY = window.scrollY;
            const scrollDirection = scrollY > lastScrollY ? 'down' : 'up';
            lastScrollY = scrollY;
            
            if (scrollY > 20) {
                nav?.classList.remove('max-w-[calc(100%-40px)]', 'md:max-w-[calc(100%-40px)]', 'xl:max-w-[1300px]', 'px-4', 'sm:px-6', 'lg:px-8');
                nav?.classList.add('max-w-[calc(100%-150px)]', 'md:max-w-[500px]', 'xl:max-w-[600px]', 'px-4');
                navBg?.classList.replace('opacity-0', 'opacity-100');
                
                if (scrollDirection === 'down') {
                    navLinks?.classList.add('opacity-0', 'pointer-events-none', '-translate-y-2');
                    navLinks?.classList.remove('translate-y-0');
                    pageTitle?.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
                    pageTitle?.classList.add('translate-y-0');
                } else {
                    navLinks?.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-2');
                    navLinks?.classList.add('translate-y-0');
                    pageTitle?.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
                    pageTitle?.classList.remove('translate-y-0');
                }
            } else {
                nav?.classList.add('max-w-[calc(100%-40px)]', 'md:max-w-[calc(100%-40px)]', 'xl:max-w-[1300px]', 'px-4', 'sm:px-6', 'lg:px-8');
                nav?.classList.remove('max-w-[calc(100%-150px)]', 'md:max-w-[500px]', 'xl:max-w-[600px]', 'px-4');
                navBg?.classList.replace('opacity-100', 'opacity-0');
                navLinks?.classList.remove('opacity-0', 'pointer-events-none');
                pageTitle?.classList.add('opacity-0', 'pointer-events-none');
            }

            if (scrollCounter && scrollValue && scrollArrow && themeToggleContainer) {
                const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = scrollHeight > 0 ? scrollY / scrollHeight : 0;
                const displayValue = Math.floor(scrollPercent * 99);

                if (scrollY > 20) {
                    // 显示滚动计数器
                    scrollCounter.classList.remove('opacity-0', 'mr-0');
                    scrollCounter.classList.add('opacity-100', 'mr-1');
                    scrollCounter.style.transform = 'scale(1)';
                    themeToggleContainer.classList.remove('mr-0', '-mr-2');
                    themeToggleContainer.classList.add('mr-2');

                    if (displayValue >= 90) {
                        scrollValue.classList.add('hidden');
                        scrollArrow.classList.remove('hidden');
                        scrollCounter.style.width = '5rem';
                    } else {
                        scrollValue.classList.remove('hidden');
                        scrollArrow.classList.add('hidden');
                        scrollCounter.style.width = '1.75rem';
                        scrollValue.textContent = displayValue.toString();
                    }
                } else {
                    // 隐藏滚动计数器
                    scrollCounter.classList.add('opacity-0', 'mr-0');
                    scrollCounter.classList.remove('opacity-100', 'mr-1');
                    scrollCounter.style.transform = 'scale(0) translateX(20px)';
                    scrollCounter.style.width = '0';
                    themeToggleContainer.classList.remove('mr-2');
                    themeToggleContainer.classList.add('mr-0', '-mr-2');
                }
            }
        }

        function setPageTitle() {
            // 在 ClientRouter 下，document.title 需要一点时间同步，或者手动获取
            if (pageTitle) {
                pageTitle.textContent = document.title;
            }
        }

        // 监听滚动
        window.addEventListener('scroll', updateHeader);
        
        // 初始运行一次
        updateHeader();
        setPageTitle();

        // 【关键】由于 ClientRouter 不会刷新窗口，我们需要在离开页面时手动移除监听器
        // 否则跳转多次后会有多个监听器在后台跑，导致内存泄漏和卡顿
        document.addEventListener('astro:before-preparation', () => {
            window.removeEventListener('scroll', updateHeader);
        }, { once: true });
    }

    // 适配 ClientRouter：首次加载和后续每次跳转后都初始化
    initHeader();
    document.addEventListener('astro:page-load', initHeader);
</script>	