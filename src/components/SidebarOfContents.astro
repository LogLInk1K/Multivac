---
---

<!-- 侧边功能图标组 - 与目录水平对称 -->
<div
  id="sidebar-of-contents"
  class="hidden xl:flex fixed top-1/2 -translate-y-1/2 left-[max(4rem,calc((100vw-1340px)/2-2rem))] z-40 flex-col gap-4"
>
  <!-- 返回顶部按钮 -->
  <div
    id="back-to-top"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-0 transition-opacity duration-500 relative"
    aria-label="返回顶部"
  >
    <!-- 左侧提示信息框（在按钮左边） -->
    <div class="absolute right-12 px-3 py-1.5 rounded-lg bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-lg opacity-0 group-hover/bar:opacity-100 transition-all duration-300 pointer-events-none whitespace-nowrap translate-x-2 group-hover/bar:translate-x-0">
      <span class="text-sm font-medium text-text-light dark:text-text-dark">返回顶部</span>
      <!-- 小三角形指示器 - 指向右侧 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>
    <!-- 圆形背景 + 向上箭头图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/40 dark:group-hover/bar:border-primary-dark/40 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 10l7-7m0 0l7 7m-7-7v18"
        ></path>
      </svg>
    </div>
  </div>

  <!-- 分享按钮（占位，始终显示） -->
  <div
    id="share-button"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-100 transition-opacity duration-500 relative"
    aria-label="分享"
  >
    <!-- 分享面板 - hover时直接显示 -->
    <div id="share-panel" class="absolute right-12 w-[320px] p-4 rounded-xl bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-2xl opacity-0 scale-95 pointer-events-none group-hover/bar:opacity-100 group-hover/bar:scale-100 group-hover/bar:pointer-events-auto transition-all duration-300 origin-right z-10">
      <div class="flex flex-col gap-3">
        <h3 class="text-base font-semibold text-text-light dark:text-text-dark">分享海报</h3>
        <p class="text-sm text-text-light/70 dark:text-text-dark/70">生成精美的分享海报</p>

        <!-- 海报预览区域 -->
        <div id="poster-preview" class="hidden w-full rounded-lg overflow-hidden border border-border-light dark:border-border-dark">
          <img id="poster-image" src="" alt="海报预览" class="w-full h-auto" />
        </div>

        <!-- 操作按钮 -->
        <div class="flex flex-col gap-2">
          <button id="generate-poster-btn" class="w-full px-3 py-2 bg-primary-light dark:bg-primary-dark text-white rounded-lg hover:opacity-80 transition-opacity text-sm font-medium">
            生成海报
          </button>
          <button id="download-poster-btn" class="hidden w-full px-3 py-2 bg-bg-light dark:bg-bg-dark border border-border-light dark:border-border-dark text-text-light dark:text-text-dark rounded-lg hover:bg-primary-light/10 dark:hover:bg-primary-dark/10 transition-colors text-sm font-medium">
            下载海报
          </button>
        </div>
      </div>
      <!-- 小三角形指示器 - 指向右侧按钮 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>

    <!-- 圆形背景 + 分享图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-sm border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/30 dark:group-hover/bar:border-primary-dark/30 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
        ></path>
      </svg>
    </div>
  </div>

  <!-- 打赏按钮（占位，始终显示） -->
  <div
    id="reward-button"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-100 transition-opacity duration-500 relative"
    aria-label="打赏"
  >
    <!-- 打赏面板 - hover时直接显示 -->
    <div id="reward-large-panel" class="absolute right-12 w-[300px] p-4 rounded-xl bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-2xl opacity-0 scale-95 pointer-events-none group-hover/bar:opacity-100 group-hover/bar:scale-100 group-hover/bar:pointer-events-auto transition-all duration-300 origin-right z-10">
      <div class="flex flex-col items-center gap-3">
        <h3 class="text-base font-semibold text-text-light dark:text-text-dark">感谢打赏</h3>
        <!-- 两个二维码左右排列 -->
        <div class="flex gap-3 items-start">
          <!-- 微信赞赏码 -->
          <div class="flex flex-col items-center gap-2">
            <div class="w-32 h-32 rounded-lg overflow-hidden bg-bg-light dark:bg-bg-dark border border-border-light dark:border-border-dark">
              <img
                src="/src/assets/wechatGood.webp"
                alt="微信赞赏码"
                class="w-full h-full object-cover"
              />
            </div>
            <span class="text-xs text-text-light/60 dark:text-text-dark/60">微信</span>
          </div>
          <!-- 支付宝赞赏码 -->
          <div class="flex flex-col items-center gap-2">
            <div class="w-32 h-32 rounded-lg overflow-hidden bg-bg-light dark:bg-bg-dark border border-border-light dark:border-border-dark">
              <img
                src="/src/assets/alipayGood.webp"
                alt="支付宝赞赏码"
                class="w-full h-full object-cover"
              />
            </div>
            <span class="text-xs text-text-light/60 dark:text-text-dark/60">支付宝</span>
          </div>
        </div>
        <p class="text-sm text-text-light/70 dark:text-text-dark/70 text-center">扫码支持作者</p>
      </div>
      <!-- 小三角形指示器 - 指向右侧按钮 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>

    <!-- 圆形背景 + 打赏图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-sm border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/30 dark:group-hover/bar:border-primary-dark/30 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
        ></path>
      </svg>
    </div>
  </div>

  <!-- 订阅按钮（占位，始终显示） -->
  <div
    id="subscribe-button"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-100 transition-opacity duration-500 relative"
    aria-label="订阅"
  >
    <!-- 订阅面板 - hover时直接显示 -->
    <div id="subscribe-panel" class="absolute right-12 w-[280px] p-4 rounded-xl bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-2xl opacity-0 scale-95 pointer-events-none group-hover/bar:opacity-100 group-hover/bar:scale-100 group-hover/bar:pointer-events-auto transition-all duration-300 origin-right z-10">
      <div class="flex flex-col gap-3">
        <h3 class="text-base font-semibold text-text-light dark:text-text-dark">RSS订阅</h3>
        <p class="text-sm text-text-light/70 dark:text-text-dark/70">通过RSS阅读器订阅本站更新</p>
        <!-- RSS图标 -->
        <div class="flex items-center justify-center py-3">
          <div class="w-16 h-16 rounded-full bg-orange-500/10 dark:bg-orange-400/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-orange-500 dark:text-orange-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
            </svg>
          </div>
        </div>
        <button class="w-full px-3 py-2 bg-primary-light dark:bg-primary-dark text-white rounded-lg hover:opacity-80 transition-opacity text-sm font-medium">
          复制RSS链接
        </button>
      </div>
      <!-- 小三角形指示器 - 指向右侧按钮 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>

    <!-- 圆形背景 + 订阅图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-sm border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/30 dark:group-hover/bar:border-primary-dark/30 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
        ></path>
      </svg>
    </div>
  </div>

  <!-- 直达评论区按钮（占位，始终显示） -->
  <div
    id="jump-to-comments"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-100 transition-opacity duration-500 relative"
    aria-label="直达评论区"
  >
    <!-- 左侧提示信息框（在按钮左边） -->
    <div class="absolute right-12 px-3 py-1.5 rounded-lg bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-lg opacity-0 group-hover/bar:opacity-100 transition-all duration-300 pointer-events-none whitespace-nowrap translate-x-2 group-hover/bar:translate-x-0">
      <span class="text-sm font-medium text-text-light dark:text-text-dark">直达评论区</span>
      <!-- 小三角形指示器 - 指向右侧 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>
    <!-- 圆形背景 + 评论图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-sm border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/30 dark:group-hover/bar:border-primary-dark/30 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
        ></path>
      </svg>
    </div>
  </div>

  <!-- 直达底部按钮 -->
  <div
    id="jump-to-bottom"
    class="flex items-center justify-end w-[180px] group/bar cursor-pointer opacity-0 transition-opacity duration-500 relative"
    aria-label="直达底部"
  >
    <!-- 左侧提示信息框（在按钮左边） -->
    <div class="absolute right-12 px-3 py-1.5 rounded-lg bg-card-light dark:bg-card-dark backdrop-blur-md border border-border-light dark:border-border-dark shadow-lg opacity-0 group-hover/bar:opacity-100 transition-all duration-300 pointer-events-none whitespace-nowrap translate-x-2 group-hover/bar:translate-x-0">
      <span class="text-sm font-medium text-text-light dark:text-text-dark">直达底部</span>
      <!-- 小三角形指示器 - 指向右侧 -->
      <div class="absolute right-[-6px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-b-[6px] border-b-transparent border-l-[6px] border-l-border-light dark:border-l-border-dark"></div>
      <div class="absolute right-[-5px] top-1/2 -translate-y-1/2 w-0 h-0 border-t-[5px] border-t-transparent border-b-[5px] border-b-transparent border-l-[5px] border-l-card-light dark:border-l-card-dark"></div>
    </div>
    <!-- 圆形背景 + 向下箭头图标 -->
    <div class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark backdrop-blur-sm border border-border-light dark:border-border-dark flex items-center justify-center group-hover/bar:bg-primary-light/10 dark:group-hover/bar:bg-primary-dark/10 group-hover/bar:border-primary-light/30 dark:group-hover/bar:border-primary-dark/30 transition-all duration-300 shadow-md hover:shadow-lg">
      <svg
        class="w-5 h-5 text-text-light/60 dark:text-text-dark/60 group-hover/bar:text-primary-light dark:group-hover/bar:text-primary-dark transition-all duration-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 14l-7 7m0 0l-7-7m7 7V3"
        ></path>
      </svg>
    </div>
  </div>
</div>

<script>
  import QRCode from 'qrcode';

  function initSidebarOfContents() {
    const sidebarContainer = document.getElementById('sidebar-of-contents');
    const backToTopButton = document.getElementById('back-to-top');
    const jumpToBottomButton = document.getElementById('jump-to-bottom');
    const jumpToCommentsButton = document.getElementById('jump-to-comments');

    if (!sidebarContainer || !backToTopButton || !jumpToBottomButton || !jumpToCommentsButton) {
      return;
    }

    // 创建一个仅包含返回顶部和直达底部的容器用于显示/隐藏
    const scrollButtons = [backToTopButton, jumpToBottomButton];

    // 显示/隐藏滚动按钮（评论区按钮始终可见）
    const toggleScrollButtons = () => {
      const scrollY = window.pageYOffset;

      // 当滚动超过 200px 时显示按钮
      if (scrollY > 200) {
        scrollButtons.forEach(button => {
          button.classList.remove('opacity-0');
          button.classList.add('opacity-100');
        });
      } else {
        scrollButtons.forEach(button => {
          button.classList.remove('opacity-100');
          button.classList.add('opacity-0');
        });
      }
    };

    // 返回顶部功能
    const scrollToTop = () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    };

    // 直达底部功能
    const scrollToBottom = () => {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth',
      });
    };

    // 初始状态
    toggleScrollButtons();
    // 评论区按钮已经通过 CSS 设置为 opacity-100，不需要额外设置

    // 监听滚动事件
    let scrollTimeout: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(toggleScrollButtons, 50);
    });

    // 直达评论区功能
    const scrollToComments = () => {
      const proseContent = document.querySelector('.prose');
      if (proseContent) {
        const proseRect = proseContent.getBoundingClientRect();
        const scrollTop = window.pageYOffset + proseRect.bottom - window.innerHeight + 650;
        window.scrollTo({
          top: scrollTop,
          behavior: 'smooth',
        });
      }
    };

    // 生成海报功能
    const generatePoster = async () => {
      const generateBtn = document.getElementById('generate-poster-btn') as HTMLButtonElement | null;
      const downloadBtn = document.getElementById('download-poster-btn') as HTMLButtonElement | null;
      const posterPreview = document.getElementById('poster-preview');
      const posterImage = document.getElementById('poster-image') as HTMLImageElement | null;

      if (!generateBtn || !downloadBtn || !posterPreview || !posterImage) return;

      try {
        generateBtn.textContent = '生成中...';
        generateBtn.disabled = true;

        // 获取当前页面信息
        const pageTitle = document.querySelector('h1')?.textContent || document.title;
        const pageDescription = (document.querySelector('meta[name="description"]') as HTMLMetaElement)?.content || '分享这篇文章';
        const pageUrl = window.location.href;

        // 获取 heroImage（从 background-image 样式中提取）
        let heroImageSrc = '';

        // 尝试多种选择器
        const selectors = [
          'article div.bg-cover.bg-center',
          'article div[class*="bg-cover"]',
          'div.bg-cover.bg-center',
          'article > div > div.bg-cover'
        ];

        for (const selector of selectors) {
          const heroImageDiv = document.querySelector(selector);
          if (heroImageDiv) {
            const bgImage = window.getComputedStyle(heroImageDiv).backgroundImage;
            console.log(`选择器 "${selector}" 找到元素，backgroundImage:`, bgImage);

            if (bgImage && bgImage !== 'none') {
              const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
              if (urlMatch) {
                heroImageSrc = urlMatch[1];
                console.log('成功提取 heroImage:', heroImageSrc);
                break;
              }
            }
          }
        }

        if (!heroImageSrc) {
          console.log('未找到 heroImage，将生成无图片版本海报');
        }

        // 创建 Canvas - 固定尺寸 750x1000
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          throw new Error('无法获取 Canvas 上下文');
        }
        const posterWidth = 750;
        const posterHeight = 1000;
        canvas.width = posterWidth;
        canvas.height = posterHeight;

        // 背景色
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, posterWidth, posterHeight);

        // 绘制 heroImage（如果存在）- 使用源矩形裁剪，避免 clip
        if (heroImageSrc) {
          try {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = heroImageSrc;
            });

            // 目标区域 - 占据45%的高度
            const targetWidth = posterWidth;
            const targetHeight = 450; // 45% of 1000px

            const imgRatio = img.width / img.height;
            const targetRatio = targetWidth / targetHeight;

            let sx, sy, sWidth, sHeight;

            if (imgRatio > targetRatio) {
              // 图片更宽，裁剪左右两侧
              sHeight = img.height;
              sWidth = sHeight * targetRatio;
              sx = (img.width - sWidth) / 2;
              sy = 0;
            } else {
              // 图片更高，裁剪上下两侧
              sWidth = img.width;
              sHeight = sWidth / targetRatio;
              sx = 0;
              sy = (img.height - sHeight) / 2;
            }

            // 使用 drawImage 的 9 参数版本：源矩形 + 目标矩形
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, targetWidth, targetHeight);
          } catch (err) {
            console.log('无法加载图片，跳过');
          }
        }

        // 绘制标题 - 左对齐，使用与描述相同的maxWidth
        ctx.fillStyle = '#1a1a1a';
        ctx.font = 'bold 48px sans-serif';
        ctx.textAlign = 'left'; // 改为左对齐
        ctx.textBaseline = 'top';
        const titleY = heroImageSrc ? 490 : 80; // 图片后留40px边距（450+40）
        const contentMaxWidth = posterWidth - 80; // 670px，与分隔线和描述宽度一致
        const titleLines = wrapText(ctx, pageTitle, 40, titleY, contentMaxWidth, 60);

        // 绘制描述 - 左对齐，maxWidth与分隔线宽度一致
        ctx.fillStyle = '#666666';
        ctx.font = '30px sans-serif';
        ctx.textAlign = 'left'; // 改为左对齐
        const descY = titleY + (titleLines * 60) + 20; // 根据标题实际行数计算位置
        wrapText(ctx, pageDescription, 40, descY, contentMaxWidth, 40);

        // 绘制分隔线 - 在二维码区域上方，与标题宽度一致
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(40, 800); // 从左边距40px开始，与标题对齐
        ctx.lineTo(posterWidth - 40, 800); // 到右边距40px结束，与标题对齐
        ctx.stroke();

        // 加载并绘制圆形头像和作者信息
        const avatarUrl = 'https://thirdqq.qlogo.cn/g?b=sdk&k=h55tiaaAAKPaziaDJ8NNkIzA&s=640&t=1627665755';
        const avatarSize = 110; // 进一步增大头像尺寸
        const avatarX = 40; // 左对齐标题位置
        const avatarY = 890; // 垂直居中于二维码区域

        // 尝试加载头像（可选）
        try {
          // 使用 fetch 通过 CORS 代理获取图片
          const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(avatarUrl)}`);
          const blob = await response.blob();
          const objectUrl = URL.createObjectURL(blob);

          const avatarImg = new Image();
          await new Promise((resolve, reject) => {
            avatarImg.onload = resolve;
            avatarImg.onerror = reject;
            avatarImg.src = objectUrl;
          });

          // 绘制圆形头像（使用 clip）
          ctx.save();
          ctx.beginPath();
          ctx.arc(avatarX + avatarSize / 2, avatarY, avatarSize / 2, 0, Math.PI * 2);
          ctx.closePath();
          ctx.clip();
          ctx.drawImage(avatarImg, avatarX, avatarY - avatarSize / 2, avatarSize, avatarSize);
          ctx.restore();

          // 清理 object URL
          URL.revokeObjectURL(objectUrl);
        } catch (err) {
          console.log('头像加载失败，将只显示文字', err);
        }

        // 绘制作者名称 "波罗歌"（无论头像是否加载成功都绘制）
        ctx.fillStyle = '#1a1a1a';
        ctx.font = 'bold 36px sans-serif'; // 进一步增大字体
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText('波罗歌', avatarX + avatarSize + 20, avatarY - 22);

        // 绘制签名 "一知半解，从一而终"
        ctx.fillStyle = '#666666';
        ctx.font = '24px sans-serif'; // 进一步增大字体
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText('一知半解，从一而终', avatarX + avatarSize + 20, avatarY + 22);

        // 生成二维码（使用本地 qrcode 库）
        const qrSize = 110; // 调整为110px

        try {
          // 使用本地 qrcode 库生成二维码
          const qrDataUrl = await QRCode.toDataURL(pageUrl, {
            width: qrSize,
            margin: 1,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          });

          // 将二维码绘制到 canvas
          const qrImg = new Image();
          await new Promise((resolve, reject) => {
            qrImg.onload = resolve;
            qrImg.onerror = reject;
            qrImg.src = qrDataUrl;
          });

          const qrX = posterWidth - 180; // 靠右放置，留出左侧空间给头像和文字
          const qrY = 825; // 分隔线下方25px
          ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

          // 二维码下方文字
          ctx.fillStyle = '#999999';
          ctx.font = '18px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('扫码查看原文', qrX + qrSize / 2, 960); // 文字位置相应调整
        } catch (err) {
          console.log('二维码生成失败', err);
        }

        // 将 Canvas 转换为图片
        const dataUrl = canvas.toDataURL('image/png');
        posterImage.src = dataUrl;
        posterPreview.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');

        // 保存 dataUrl 供下载使用
        downloadBtn.dataset.posterUrl = dataUrl;

        generateBtn.textContent = '重新生成';
        generateBtn.disabled = false;
      } catch (error) {
        console.error('生成海报失败:', error);
        generateBtn.textContent = '生成失败，重试';
        generateBtn.disabled = false;
      }
    };

    // 文字换行辅助函数 - 返回实际绘制的行数
    function wrapText(ctx: CanvasRenderingContext2D, text: string, x: number, y: number, maxWidth: number, lineHeight: number): number {
      const lines = [];
      let currentLine = '';
      const maxLines = 3;

      // 第一步：将文本分割成行
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const testLine = currentLine + char;
        const testWidth = ctx.measureText(testLine).width;

        if (testWidth > maxWidth && currentLine.length > 0) {
          // 当前行已满，保存当前行，开始新行
          lines.push(currentLine);
          currentLine = char; // 当前字符作为新行的第一个字符
        } else {
          // 继续添加到当前行
          currentLine = testLine;
        }
      }

      // 添加最后一行
      if (currentLine.length > 0) {
        lines.push(currentLine);
      }

      // 第二步：绘制行（最多3行）
      for (let i = 0; i < Math.min(lines.length, maxLines); i++) {
        let lineText = lines[i];

        // 如果是第3行且还有更多内容，添加省略号
        if (i === maxLines - 1 && lines.length > maxLines) {
          const ellipsis = '...';
          // 确保省略号能放得下
          while (ctx.measureText(lineText + ellipsis).width > maxWidth && lineText.length > 1) {
            lineText = lineText.slice(0, -1);
          }
          lineText += ellipsis;
        }

        ctx.fillText(lineText, x, y + i * lineHeight);
      }

      // 返回实际绘制的行数
      return Math.min(lines.length, maxLines);
    }

    // 下载海报
    const downloadPoster = () => {
      const downloadBtn = document.getElementById('download-poster-btn');
      if (!downloadBtn || !downloadBtn.dataset.posterUrl) return;

      const link = document.createElement('a');
      link.download = 'poster.png';
      link.href = downloadBtn.dataset.posterUrl;
      link.click();
    };

    // 监听点击事件
    backToTopButton.addEventListener('click', scrollToTop);
    jumpToBottomButton.addEventListener('click', scrollToBottom);
    jumpToCommentsButton.addEventListener('click', scrollToComments);

    // 海报生成按钮
    const generatePosterBtn = document.getElementById('generate-poster-btn');
    const downloadPosterBtn = document.getElementById('download-poster-btn');
    if (generatePosterBtn) {
      generatePosterBtn.addEventListener('click', generatePoster);
    }
    if (downloadPosterBtn) {
      downloadPosterBtn.addEventListener('click', downloadPoster);
    }
  }

  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initSidebarOfContents, 100);
    });
  } else {
    setTimeout(initSidebarOfContents, 100);
  }

  // 监听 Astro 页面转换
  document.addEventListener('astro:after-swap', () => {
    setTimeout(initSidebarOfContents, 100);
  });
</script>
