---
/**
 * å¯†ç ä¿æŠ¤ç»„ä»¶
 * å·²é‡æ„ä¸ºæ”¯æŒå¤šå®ä¾‹å…±å­˜ï¼Œæ¶ˆé™¤ ID å†²çªè­¦å‘Š
 */
interface Props {
    passwordHint?: string;
}

const { passwordHint } = Astro.props;
const defaultHint = 'ğŸ’¡ æç¤ºï¼šå¯†ç ç”±æ–‡ç« ä½œè€…è®¾ç½®';
---

<div data-password-container class="max-w-md mx-auto mt-16 p-8 bg-card-light dark:bg-card-dark rounded-2xl shadow-xl">
    <div class="text-center mb-6">
        <svg class="w-16 h-16 mx-auto mb-4 text-primary-light dark:text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        <div class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">æ­¤æ–‡ç« å·²åŠ å¯†</div>
        <p class="text-text-light/70 dark:text-text-dark/70">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</p>
    </div>

    <form data-password-form class="space-y-4">
        <div>
            <input
                type="password"
                data-password-input
                placeholder="è¯·è¾“å…¥å¯†ç "
                autocomplete="off"
                class="w-full px-4 py-3 bg-background-light dark:bg-background-dark border-2 border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:border-primary-light dark:focus:border-primary-dark transition-colors text-text-light dark:text-text-dark"
            />
        </div>

        <div data-error-message class="hidden text-red-500 text-sm text-center"></div>

        <button
            type="submit"
            class="w-full px-6 py-3 bg-primary-light dark:bg-primary-dark text-white rounded-lg font-medium hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:ring-offset-2"
        >
            è§£é”æ–‡ç« 
        </button>
    </form>

    <div class="mt-6 text-center text-sm text-text-light/60 dark:text-text-dark/60">
        <p>{passwordHint || defaultHint}</p>
    </div>
</div>

<div data-encrypted-content class="hidden prose prose-lg max-w-none text-text-light dark:prose-invert dark:text-text-dark prose-headings:font-bold prose-a:text-primary-light dark:prose-a:text-primary-dark prose-blockquote:border-l-primary-light dark:prose-blockquote:border-l-primary-dark"></div>

<script>
    import { decryptContent } from '../scripts/crypto';
    import { marked } from 'marked';

    function initPasswordProtection() {
        // æŸ¥æ‰¾é¡µé¢ä¸Šæ‰€æœ‰çš„åŠ å¯†ç»„ä»¶å®ä¾‹
        const containers = document.querySelectorAll('[data-password-container]');

        containers.forEach((container) => {
            const form = container.querySelector('[data-password-form]') as HTMLFormElement;
            const passwordInput = container.querySelector('[data-password-input]') as HTMLInputElement;
            const errorMessage = container.querySelector('[data-error-message]') as HTMLDivElement;
            const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
            
            // è¿™é‡Œå‡è®¾å†…å®¹å®¹å™¨åœ¨ç»„ä»¶åŒçº§æˆ–å…¨å±€ï¼Œä½¿ç”¨ data é€‰æ‹©å™¨æ›´å®‰å…¨
            const encryptedContent = document.querySelector('[data-encrypted-content]') as HTMLDivElement;

            if (!form || !passwordInput || !encryptedContent) return;

            // è·å–å½“å‰é¡µé¢çš„åŠ å¯†æ•°æ®
            const encryptedData = (window as any).__ENCRYPTED_CONTENT__;
            let isAutoAttempt = false;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const password = passwordInput.value.trim();
                if (!password) {
                    showError('è¯·è¾“å…¥å¯†ç ');
                    return;
                }

                const originalText = submitButton.textContent;

                try {
                    if (!isAutoAttempt) {
                        submitButton.textContent = 'è§£å¯†ä¸­...';
                        submitButton.disabled = true;
                    }
                    errorMessage.classList.add('hidden');

                    // æ ¸å¿ƒè§£å¯†é€»è¾‘
                    const decryptedMarkdown = await decryptContent(encryptedData, password);
                    const html = await marked.parse(decryptedMarkdown);

                    // ç•Œé¢çŠ¶æ€åˆ‡æ¢
                    encryptedContent.innerHTML = html;
                    encryptedContent.classList.remove('hidden');
                    container.classList.add('hidden');

                    // å­˜å‚¨å¯†ç 
                    sessionStorage.setItem('article-password', password);

                    // è§¦å‘ç›®å½•é‡æ–°åˆå§‹åŒ– (å¦‚æœå­˜åœ¨)
                    if (typeof (window as any).initTableOfContents === 'function') {
                        setTimeout(() => (window as any).initTableOfContents(), 100);
                    }

                } catch (error) {
                    if (!isAutoAttempt) {
                        showError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        passwordInput.value = '';
                        passwordInput.focus();
                    } else {
                        passwordInput.value = '';
                        sessionStorage.removeItem('article-password'); // è‡ªåŠ¨å°è¯•å¤±è´¥åˆ™æ¸…é™¤å¤±æ•ˆå¯†ç 
                    }
                } finally {
                    isAutoAttempt = false;
                }
            });

            function showError(message: string) {
                if (!errorMessage) return;
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }

            // è‡ªåŠ¨è§£é”å°è¯•
            const savedPassword = sessionStorage.getItem('article-password');
            if (savedPassword && encryptedData) {
                passwordInput.value = savedPassword;
                isAutoAttempt = true;
                form.dispatchEvent(new Event('submit'));
            }
        });
    }

    // åˆå§‹åŒ–å¹¶é€‚é… Astro View Transitions
    initPasswordProtection();
    document.addEventListener('astro:page-load', initPasswordProtection);
</script>