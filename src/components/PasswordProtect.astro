---
/**
 * å¯†ç ä¿æŠ¤ç»„ä»¶
 * ç”¨äºæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
 */
interface Props {
	passwordHint?: string;
}

const { passwordHint } = Astro.props;
const defaultHint = 'ğŸ’¡ æç¤ºï¼šå¯†ç ç”±æ–‡ç« ä½œè€…è®¾ç½®';
---

<div id="password-protect" class="max-w-md mx-auto mt-16 p-8 bg-card-light dark:bg-card-dark rounded-2xl shadow-xl">
	<div class="text-center mb-6">
		<svg class="w-16 h-16 mx-auto mb-4 text-primary-light dark:text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
		</svg>
		<div class="text-2xl font-bold text-text-light dark:text-text-dark mb-2">æ­¤æ–‡ç« å·²åŠ å¯†</div>
		<p class="text-text-light/70 dark:text-text-dark/70">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</p>
	</div>

	<form id="password-form" class="space-y-4">
		<div>
			<input
				type="password"
				id="password-input"
				placeholder="è¯·è¾“å…¥å¯†ç "
				autocomplete="off"
				class="w-full px-4 py-3 bg-background-light dark:bg-background-dark border-2 border-border-light dark:border-border-dark rounded-lg focus:outline-none focus:border-primary-light dark:focus:border-primary-dark transition-colors text-text-light dark:text-text-dark"
			/>
		</div>

		<div id="error-message" class="hidden text-red-500 text-sm text-center"></div>

		<button
			type="submit"
			class="w-full px-6 py-3 bg-primary-light dark:bg-primary-dark text-white rounded-lg font-medium hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark focus:ring-offset-2"
		>
			è§£é”æ–‡ç« 
		</button>
	</form>

	<div class="mt-6 text-center text-sm text-text-light/60 dark:text-text-dark/60">
		<p>{passwordHint || defaultHint}</p>
	</div>
</div>

<div id="encrypted-content" class="hidden prose prose-lg max-w-none text-text-light dark:prose-invert dark:text-text-dark prose-headings:font-bold prose-a:text-primary-light dark:prose-a:text-primary-dark prose-blockquote:border-l-primary-light dark:prose-blockquote:border-l-primary-dark prose-code:bg-badge-light dark:prose-code:bg-badge-dark"></div>

<script>
	import { decryptContent } from '../scripts/crypto';
	import { marked } from 'marked';

	const form = document.getElementById('password-form') as HTMLFormElement;
	const passwordInput = document.getElementById('password-input') as HTMLInputElement;
	const errorMessage = document.getElementById('error-message') as HTMLDivElement;
	const passwordProtect = document.getElementById('password-protect') as HTMLDivElement;
	const encryptedContent = document.getElementById('encrypted-content') as HTMLDivElement;

	// ä»é¡µé¢ä¸­è·å–åŠ å¯†å†…å®¹
	const encryptedData = (window as any).__ENCRYPTED_CONTENT__;

	const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
	let isAutoAttempt = false; // æ ‡è®°æ˜¯å¦ä¸ºè‡ªåŠ¨å°è¯•

	form.addEventListener('submit', async (e) => {
		e.preventDefault();

		const password = passwordInput.value.trim();

		if (!password) {
			showError('è¯·è¾“å…¥å¯†ç ');
			return;
		}

		const originalText = submitButton.textContent;

		try {
			// æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆä»…åœ¨éè‡ªåŠ¨å°è¯•æ—¶æ˜¾ç¤ºï¼‰
			if (!isAutoAttempt) {
				submitButton.textContent = 'è§£å¯†ä¸­...';
				submitButton.disabled = true;
			}
			errorMessage.classList.add('hidden');

			// è§£å¯†å†…å®¹ï¼ˆå¾—åˆ° markdown æ–‡æœ¬ï¼‰
			const decryptedMarkdown = await decryptContent(encryptedData, password);

			// å°† markdown è½¬æ¢ä¸º HTML
			const html = await marked.parse(decryptedMarkdown);

			// æ˜¾ç¤ºè§£å¯†åçš„å†…å®¹
			encryptedContent.innerHTML = html;
			encryptedContent.classList.remove('hidden');
			passwordProtect.classList.add('hidden');

			// ä¿å­˜å¯†ç åˆ° sessionStorageï¼ˆä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
			sessionStorage.setItem('article-password', password);

			// è§¦å‘ç›®å½•é‡æ–°åˆå§‹åŒ–
			if (typeof (window as any).initTableOfContents === 'function') {
				setTimeout(() => {
					(window as any).initTableOfContents();
				}, 100);
			}

		} catch (error) {
			// åªåœ¨ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ—¶æ˜¾ç¤ºé”™è¯¯
			if (!isAutoAttempt) {
				showError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
				submitButton.textContent = originalText;
				submitButton.disabled = false;
				passwordInput.value = '';
				passwordInput.focus();
			} else {
				// è‡ªåŠ¨å°è¯•å¤±è´¥ï¼Œé™é»˜å¤„ç†ï¼Œæ¸…ç©ºè¾“å…¥æ¡†
				passwordInput.value = '';
			}
		} finally {
			isAutoAttempt = false; // é‡ç½®æ ‡å¿—
		}
	});

	function showError(message: string) {
		errorMessage.textContent = message;
		errorMessage.classList.remove('hidden');
	}

	// æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¿å­˜çš„å¯†ç ï¼Œé™é»˜å°è¯•è‡ªåŠ¨è§£é”
	const savedPassword = sessionStorage.getItem('article-password');
	if (savedPassword && encryptedData) {
		passwordInput.value = savedPassword;
		isAutoAttempt = true; // æ ‡è®°ä¸ºè‡ªåŠ¨å°è¯•
		form.dispatchEvent(new Event('submit'));
	}
</script>
