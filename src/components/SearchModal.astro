<div id="search-modal" class="fixed inset-0 z-[100] hidden">
  <div 
    id="search-backdrop"
    class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity duration-300 opacity-0"
  ></div>
  
  <div 
    id="search-content"
    class="absolute top-[20%] left-1/2 -translate-x-1/2 w-full max-w-2xl px-4 transition-all duration-300 scale-95 opacity-0"
  >
    <div class="bg-card-light dark:bg-card-dark rounded-3xl shadow-2xl overflow-hidden border border-border-light dark:border-border-dark">
      <div class="p-4 border-b border-border-light dark:border-border-dark">
        <div class="relative">
          <svg 
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-light dark:text-text-dark opacity-60" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path 
              stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2" 
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
          </svg>
          <input 
            type="text" 
            id="search-input"
            placeholder="æœç´¢æ–‡ç« ..." 
            class="w-full pl-12 pr-4 py-3 bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark transition-all"
            autocomplete="off"
          />
          <kbd class="absolute right-4 top-1/2 -translate-y-1/2 px-2 py-1 text-xs bg-hover-light dark:bg-hover-dark text-text-light dark:text-text-dark rounded opacity-60">ESC</kbd>
        </div>
      </div>
      
      <div id="search-results" class="max-h-[60vh] overflow-y-auto p-2">
        <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
          è¾“å…¥å…³é”®è¯æœç´¢æ–‡ç« ğŸ˜‹
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  let modal;
  let backdrop;
  let content;
  let input;
  let resultsContainer;
  let allPosts = null;
  let isLoadingData = false;

  async function loadSearchData() {
    if (allPosts !== null || isLoadingData) return;
    isLoadingData = true;

    try {
      const response = await fetch('/search-data.json');
      if (!response.ok) throw new Error('Failed to load search data');
      allPosts = await response.json();
    } catch (error) {
      console.error('Failed to load search data:', error);
      allPosts = [];
    } finally {
      isLoadingData = false;
    }
  }

  function initElements() {
    modal = document.getElementById('search-modal');
    backdrop = document.getElementById('search-backdrop');
    content = document.getElementById('search-content');
    input = document.getElementById('search-input');
    resultsContainer = document.getElementById('search-results');
  }

  function openModal() {
    initElements();
    modal?.classList.remove('hidden');
    setTimeout(() => {
      backdrop?.classList.remove('opacity-0');
      content?.classList.remove('scale-95', 'opacity-0');
      content?.classList.add('scale-100', 'opacity-100');
      input?.focus();
    }, 10);
    document.body.style.overflow = 'hidden';

    // é¢„åŠ è½½æœç´¢æ•°æ®
    loadSearchData();
  }

  function closeModal() {
    initElements();
    backdrop?.classList.add('opacity-0');
    content?.classList.remove('scale-100', 'opacity-100');
    content?.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      modal?.classList.add('hidden');
      if (input) input.value = '';
      resetResults();
    }, 300);
    document.body.style.overflow = '';
  }

  function searchPosts(query) {
    const lowerQuery = query.toLowerCase().trim();

    if (!lowerQuery) {
      return null;
    }

    if (!allPosts || allPosts.length === 0) {
      return [];
    }

    const searchResults = allPosts.filter((post) => {
      const title = post.title.toLowerCase();
      const description = post.description.toLowerCase();
      const tags = post.tags?.map((tag) => tag.toLowerCase()) || [];
      const category = post.category?.toLowerCase() || '';
      
      let bodyText = '';
      if (post.body) {
        bodyText = post.body
          .toLowerCase()
          .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
          .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
          .replace(/<[^>]+>/g, '')
          .replace(/&nbsp;/g, ' ')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&')
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/\s+/g, ' ')
          .trim();
      }

      return (
        title.includes(lowerQuery) ||
        description.includes(lowerQuery) ||
        tags.some((tag) => tag.includes(lowerQuery)) ||
        category.includes(lowerQuery) ||
        bodyText.includes(lowerQuery)
      );
    }).map((post) => {
      const title = post.title.toLowerCase();
      const description = post.description.toLowerCase();
      const tags = post.tags?.map((tag) => tag.toLowerCase()) || [];
      const category = post.category?.toLowerCase() || '';
      
      let bodyText = '';
      if (post.body) {
        bodyText = post.body
          .toLowerCase()
          .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
          .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
          .replace(/<[^>]+>/g, '')
          .replace(/&nbsp;/g, ' ')
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&')
          .replace(/&quot;/g, '"')
          .replace(/&#39;/g, "'")
          .replace(/\s+/g, ' ')
          .trim();
      }

      const titleMatch = title.includes(lowerQuery);
      const descriptionMatch = description.includes(lowerQuery);
      const tagsMatch = tags.some((tag) => tag.includes(lowerQuery));
      const categoryMatch = category.includes(lowerQuery);
      const bodyMatch = bodyText.includes(lowerQuery);

      let matchText = '';
      if (bodyMatch && !titleMatch && !descriptionMatch && !tagsMatch && !categoryMatch) {
        const index = bodyText.indexOf(lowerQuery);
        const start = Math.max(0, index - 50);
        const end = Math.min(bodyText.length, index + lowerQuery.length + 50);
        const beforeText = bodyText.substring(start, index);
        const afterText = bodyText.substring(index + lowerQuery.length, end);
        const keywordText = bodyText.substring(index, index + lowerQuery.length);
        matchText = '...' + beforeText + `<span class="text-primary-light dark:text-primary-dark font-bold">${keywordText}</span>` + afterText + '...';
      }
      
      return {
        ...post,
        matchText: matchText || post.description || 'æš‚æ— æè¿°'
      };
    });

    return searchResults;
  }

  function resetResults() {
    initElements();
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
      <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
        è¾“å…¥å…³é”®è¯æœç´¢æ–‡ç« 
      </div>
    `;
  }

  function renderResults(results) {
    initElements();
    if (!resultsContainer) return;

    console.log('Rendering results:', results.length, 'posts');

    if (results === null || results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
          æœªæ‰¾åˆ°ç›¸å…³æ–‡ç« 
        </div>
      `;
      return;
    }

    resultsContainer.innerHTML = results.map((post) => {
      const titleHtml = post.title;
      const matchHtml = post.matchText;
      
      return `
      <a
        href="/p/${post.originalFileName}.html"
        class="block p-4 rounded-2xl hover:bg-hover-light dark:hover:bg-hover-dark transition-colors group"
      >
        <h3 class="font-bold text-text-light dark:text-text-dark group-hover:text-primary-light dark:group-hover:text-primary-dark transition-colors mb-1">
          ${titleHtml}
        </h3>
        <p class="text-sm text-text-light dark:text-text-dark opacity-70 line-clamp-2">
          ${matchHtml}
        </p>
      </a>
      `;
    }).join('');
  }

  let searchTimeout;
  let inputListener;
  let backdropListener;
  let keydownListener;

  function setupEventListeners() {
    initElements();
    
    // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (inputListener && input) {
      input.removeEventListener('input', inputListener);
    }
    if (backdropListener && backdrop) {
      backdrop.removeEventListener('click', backdropListener);
    }
    if (keydownListener) {
      document.removeEventListener('keydown', keydownListener);
    }
    
    // åˆ›å»ºæ–°çš„ç›‘å¬å™¨
    inputListener = async (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value;

      if (!query.trim()) {
        resetResults();
        return;
      }

      // ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ
      if (isLoadingData) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
              æ­£åœ¨åŠ è½½æœç´¢æ•°æ®...
            </div>
          `;
        }
        // ç­‰å¾…æ•°æ®åŠ è½½
        await new Promise(resolve => {
          const checkData = setInterval(() => {
            if (!isLoadingData) {
              clearInterval(checkData);
              resolve();
            }
          }, 50);
        });
      }

      if (!allPosts || allPosts.length === 0) {
        if (resultsContainer) {
          resultsContainer.innerHTML = `
            <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
              æœç´¢æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
            </div>
          `;
        }
        return;
      }

      if (resultsContainer) {
        resultsContainer.innerHTML = `
          <div class="text-center py-8 text-text-light dark:text-text-dark opacity-60">
            æœç´¢ä¸­...
          </div>
        `;
      }

      searchTimeout = setTimeout(() => {
        const results = searchPosts(query);
        renderResults(results);
      }, 300);
    };

    backdropListener = () => {
      closeModal();
    };

    keydownListener = (e) => {
      if (e.key === 'Escape') {
        initElements();
        if (!modal?.classList.contains('hidden')) {
          closeModal();
        }
      }
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        initElements();
        if (modal?.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      }
    };

    // æ·»åŠ æ–°çš„ç›‘å¬å™¨
    if (input) input.addEventListener('input', inputListener);
    if (backdrop) backdrop.addEventListener('click', backdropListener);
    document.addEventListener('keydown', keydownListener);
  }

  function cleanupEventListeners() {
    if (inputListener && input) {
      input.removeEventListener('input', inputListener);
    }
    if (backdropListener && backdrop) {
      backdrop.removeEventListener('click', backdropListener);
    }
    if (keydownListener) {
      document.removeEventListener('keydown', keydownListener);
    }
  }

  window.openSearchModal = openModal;

  function init() {
    // ç¡®ä¿æ¨¡æ€æ¡†åœ¨é¡µé¢åˆ‡æ¢æ—¶æ˜¯å…³é—­çŠ¶æ€
    closeModal();
    setupEventListeners();
  }

  // é€‚é… ClientRouter ç”Ÿå‘½å‘¨æœŸ
  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
  
  // åœ¨é¡µé¢åˆ‡æ¢å‰æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  document.addEventListener('astro:before-preparation', cleanupEventListeners);
</script>
