---
import { getCollection, getEntry } from 'astro:content';

const posts = await getCollection('post', ({ data }) => !data.draft && !data.friends && !data.friendGroups && !data.moments);

// é»˜è®¤æœ€è¿‘åœ¨çœ‹æ•°æ®
const defaultWatching = [
  {
    title: 'è™«å¸ˆ',
    year: 2005,
    cover: '/img/df-cover.webp',
    rating: 9.4,
    comment: 'è¿œå±±å¦‚é›¾',
    type: 'anime',
  },
  {
    title: 'æ— å¤´éª‘å£«å¼‚é—»å½•',
    year: 2010,
    cover: '/img/df-cover.webp',
    rating: 8.8,
    comment: 'è¿™é‡Œæ˜¯æ± è¢‹',
    type: 'anime',
  },
];

// è¯»å–æœ€è¿‘åœ¨çœ‹çš„æ•°æ®
let watchingList = defaultWatching;
try {
  const watchingData = await getEntry('post', 'watching');
  if (watchingData && watchingData.data.watching) {
    watchingList = watchingData.data.watching;
  }
} catch (error) {
  // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
  console.log('Using default watching data');
}

const categories = posts.reduce((acc, post) => {
  const category = post.data.category;
  if (category) {
    acc[category] = (acc[category] || 0) + 1;
  }
  return acc;
}, {} as Record<string, number>);

const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<aside class="hidden md:block w-[272px] space-y-6">
  <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
  <div class="p-4 h-[300px] bg-primary-light dark:bg-primary-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 matrix-card relative overflow-hidden border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <!-- é¡¶éƒ¨ï¼šé†‰åä¸çŸ¥å¤©åœ¨æ°´ æ–‡æœ¬ -->
    <div class="absolute top-4 left-0 right-0 flex justify-center">
      <div class="px-3 py-1 bg-white/20 dark:bg-black/50 rounded-full greeting-container">
        <span class="text-sm font-medium text-white greeting-text" style="will-change: transform, opacity; text-rendering: optimizeSpeed;">é†‰åä¸çŸ¥å¤©åœ¨æ°´</span>
      </div>
    </div>
    <!-- ä¸­é—´ï¼šå¤´åƒ -->
    <div class="absolute top-0 left-0 right-0 bottom-0 flex justify-center items-center pt-12 pb-16">
      <div class="relative avatar-container">
        <div class="avatar-mouse-wrapper transform-gpu">
          <img
            src="https://qlogo.1k.ink/avatar.webp"
            alt="åšä¸»å¤´åƒ"
            class="w-[115px] rounded-full object-cover border-4 border-white dark:border-white shadow-lg avatar-image transform-gpu cursor-pointer"
          />
        </div>
      </div>
    </div>
    <!-- åº•éƒ¨ï¼šä¿¡æ¯åŒº -->
    <div class="absolute bottom-4 left-4 right-4 flex justify-between items-center">
      <!-- å·¦ä¾§ï¼šåšä¸»ä¿¡æ¯å®¹å™¨ -->
      <a href="/about" class="text-container block hover:opacity-85 transition-opacity duration-200">
        <h2 class="text-xl font-bold text-white dark:text-black mb-1 matrix-text" data-text="æ³¢ç½—æ­Œ">æ³¢ç½—æ­Œ</h2>
        <p class="text-xs text-white dark:text-black/90 opacity-60 matrix-text" data-text="ä¸‡ç»´ç½‘ä¸­æ½®æ±›æ¥">ä¸‡ç»´ç½‘ä¸­æ½®æ±›æ¥</p>
      </a>

      <!-- å³ä¾§ï¼šç¤¾äº¤å›¾æ ‡å®¹å™¨ -->
      <div class="icons-container flex space-x-2">
        <a href="https://github.com/LogLInk1K" target="_blank" rel="noopener noreferrer" 
           class="text-white hover:text-white transition-all duration-200 hover:scale-110 relative group w-10 h-10 rounded-full bg-white/20 dark:bg-black/50 hover:bg-white/30 dark:hover:bg-black/70 flex items-center justify-center">
          <span class="sr-only">GitHub</span>
          <svg viewBox="0 0 16 16" aria-hidden="true" width="20">
            <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-white text-black dark:bg-black dark:text-white text-sm rounded-lg shadow-md opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none whitespace-nowrap">
            GitHub
          </div>
        </a>
        <a href="https://space.bilibili.com/12787362" target="_blank" rel="noopener noreferrer" 
           class="text-white hover:text-white transition-all duration-200 hover:scale-110 relative group w-10 h-10 rounded-full bg-white/20 dark:bg-black/50 hover:bg-white/30 dark:hover:bg-black/70 flex items-center justify-center">
          <span class="sr-only">Bilibili</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" width="20">
            <path fill="currentColor" d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"></path>
          </svg>
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-white text-black dark:bg-black dark:text-white text-sm rounded-lg shadow-md opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none whitespace-nowrap">
            Bilibili
          </div>
        </a>
      </div>
    </div>

    <!-- Matrix Effect Script -->
    <script>
      let matrixInterval: number | undefined, avatarInterval: number | undefined, matrixTimeout: number | undefined;
      let animationFrameId: number | undefined;

      function initMatrixEffects() {
        const matrixCard = document.querySelector('.matrix-card');
        const matrixTexts = matrixCard?.querySelectorAll('.matrix-text') || [];
        const matrixChars = '0123456789ABCDEFG';
        let isAnimating = false;
        let changeCount = 0; // è·Ÿè¸ªå¥‡æ•°æ¬¡/å¶æ•°æ¬¡å˜åŒ–çš„è®¡æ•°å™¨

        // æ¸…ç†æ—§çš„å®šæ—¶å™¨
        if (matrixInterval) clearInterval(matrixInterval);
        if (avatarInterval) clearInterval(avatarInterval);
        if (matrixTimeout) clearTimeout(matrixTimeout);
        if (animationFrameId) cancelAnimationFrame(animationFrameId);

        // é—®å€™è¯­åˆ—è¡¨ï¼Œä¸emojiå¯¹åº”
        const greetings = [
          'ä¼ å¥‡ä¸»å”±äº•èŠ¹ä»èœ',
          'ç£åœºè½¬åŠ¨ä¹åä¹ä¸‡åŒ¹ï¼',
          'å…¨æ¬¾æ‹¿ä¸‹ç–¯ç‹‚æ˜ŸæœŸå››',
          'å’•å’•å˜å˜ï¼å’•å˜ï¼Ÿ',
          'æ„Ÿè§‰ä¸å¦‚â€¦â€¦åŸç¥',
          'çŸ¥è¯†å­¦çˆ†'
        ];

        // å¤´åƒåˆ‡æ¢æ•ˆæœ
        const avatarContainer = document.querySelector('.avatar-container') as HTMLElement;
        const avatarImage = document.querySelector('.avatar-image') as HTMLImageElement;
        const emojis = ['ğŸ˜', 'ğŸ˜¼', 'ğŸ˜‹', 'ğŸ˜­', 'ğŸ¤“', 'ğŸ¤£'];
        let currentEmojiIndex = 0;
        let isAvatarAnimating = false;

        // ============ é¼ æ ‡è·Ÿéšæ•ˆæœ ============
        const mouseWrapper = document.querySelector('.avatar-mouse-wrapper') as HTMLElement;
        let mouseX = 0, mouseY = 0;
        let currentX = 0, currentY = 0;
        const lerpFactor = 0.04; // è¿›ä¸€æ­¥é™ä½æ’å€¼å› å­ä»¥è·å¾—æ›´å¹³æ»‘çš„æ•ˆæœ
        const maxMoveDistance = 6; // å‡å°ç§»åŠ¨è·ç¦»é¿å…æŠ–åŠ¨
        let isHovering = false;

        // ä¸ºå¤´åƒå’Œemojiå®¹å™¨æ·»åŠ é¼ æ ‡è·Ÿè¸ª
        if (mouseWrapper) {
          mouseWrapper.addEventListener('mouseenter', () => {
            isHovering = true;
          });

          mouseWrapper.addEventListener('mousemove', (e: Event) => {
            if (!isHovering) return;

            const mouseEvent = e as MouseEvent;
            const rect = mouseWrapper.getBoundingClientRect();

            // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºå…ƒç´ ä¸­å¿ƒçš„åç§»
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            // ç®€å•çš„å½’ä¸€åŒ–åç§»é‡ (-1 åˆ° 1)
            const normalizedX = (mouseEvent.clientX - centerX) / (rect.width / 2);
            const normalizedY = (mouseEvent.clientY - centerY) / (rect.height / 2);

            // é™åˆ¶èŒƒå›´å¹¶åº”ç”¨ç§»åŠ¨è·ç¦»
            mouseX = Math.max(-1, Math.min(1, normalizedX)) * maxMoveDistance;
            mouseY = Math.max(-1, Math.min(1, normalizedY)) * maxMoveDistance;
          });

          mouseWrapper.addEventListener('mouseleave', () => {
            isHovering = false;
            mouseX = 0;
            mouseY = 0;
          });
        }

        // å¹³æ»‘åŠ¨ç”»å¾ªç¯
        function animateMouseFollow() {
          // æ£€æŸ¥ mouseWrapper æ˜¯å¦å­˜åœ¨
          if (!mouseWrapper) return;

          // çº¿æ€§æ’å€¼å®ç°å¹³æ»‘è·Ÿéš
          currentX += (mouseX - currentX) * lerpFactor;
          currentY += (mouseY - currentY) * lerpFactor;

          // åº”ç”¨å˜æ¢
          mouseWrapper.style.transform = `translate(${currentX}px, ${currentY}px)`;

          animationFrameId = requestAnimationFrame(animateMouseFollow);
        }

        // åªæœ‰å½“ mouseWrapper å­˜åœ¨æ—¶æ‰å¯åŠ¨åŠ¨ç”»
        if (mouseWrapper) {
          animateMouseFollow();
        }
        // ============ é¼ æ ‡è·Ÿéšæ•ˆæœç»“æŸ ============

        // åˆå§‹åŒ–æ—¶ä¸ä¿®æ”¹é—®å€™è¯­ï¼Œä¿æŒé»˜è®¤çš„"é†‰åä¸çŸ¥å¤©åœ¨æ°´"æ˜¾ç¤º
        // ç¬¬ä¸€æ¬¡åŠ¨ç”»æ—¶å†æ˜¾ç¤ºç¬¬ä¸€ä¸ªé—®å€™è¯­

        // Matrixæ•ˆæœå‡½æ•°
        function triggerMatrixEffect() {
          if (isAnimating || matrixTexts.length === 0) return;
          isAnimating = true;
          changeCount++;
          
          // ä¸ºæ¯ä¸ªæ–‡æœ¬å…ƒç´ æ·»åŠ åŠ¨ç”»æ•ˆæœ
          matrixTexts.forEach((element, index) => {
            const originalText = (element as HTMLElement).dataset.text || '';
            if (!originalText) return;
            const chars = originalText.split('');
            const isEvenIndex = index % 2 === 0;
            const isEvenChange = changeCount % 2 === 0;
            // æ ¹æ®ç´¢å¼•å’Œå˜åŒ–æ¬¡æ•°å…±åŒå†³å®šåŠ¨ç”»æ–¹å‘
            const shouldReverse = isEvenChange ? isEvenIndex : !isEvenIndex;
            let revealIndex = shouldReverse ? chars.length : 0;
            
            // åˆå§‹å­—ç¬¦æ‰“ä¹±
            element.textContent = chars.map(() => matrixChars[Math.floor(Math.random() * matrixChars.length)]).join('');
            
            // é€ä¸ªå­—ç¬¦åŠ¨ç”»æ˜¾ç¤º
            const scrambleInterval = setInterval(() => {
              element.textContent = element.textContent.split('').map((_, i) => {
                if (shouldReverse) {
                  // ä»å³åˆ°å·¦åŠ¨ç”»
                  return i >= revealIndex ? originalText[i] : matrixChars[Math.floor(Math.random() * matrixChars.length)];
                } else {
                  // ä»å·¦åˆ°å³åŠ¨ç”»
                  return i < revealIndex ? originalText[i] : matrixChars[Math.floor(Math.random() * matrixChars.length)];
                }
              }).join('');
              
              // æ ¹æ®åŠ¨ç”»æ–¹å‘æ›´æ–°æ˜¾ç¤ºç´¢å¼•
              if (shouldReverse) {
                revealIndex--;
                if (revealIndex < 0) {
                  clearInterval(scrambleInterval);
                  element.textContent = originalText;
                  if (index === matrixTexts.length - 1) {
                    isAnimating = false;
                  }
                }
              } else {
                revealIndex++;
                if (revealIndex > originalText.length) {
                  clearInterval(scrambleInterval);
                  element.textContent = originalText;
                  if (index === matrixTexts.length - 1) {
                    isAnimating = false;
                  }
                }
              }
            }, 50);
          });
        }
        
        // ä¸ºå¡ç‰‡å’Œæ–‡æœ¬å®¹å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        if (matrixCard) matrixCard.addEventListener('mouseenter', triggerMatrixEffect);
        const textContainer = matrixCard?.querySelector('.text-container');
        if (textContainer) {
          textContainer.addEventListener('mouseenter', triggerMatrixEffect);
        }

        // æ¯3ç§’è‡ªåŠ¨è§¦å‘ä¸€æ¬¡Matrixæ•ˆæœ
        matrixInterval = setInterval(triggerMatrixEffect, 10000) as unknown as number;
        
        // å¤´åƒåˆ‡æ¢æ•ˆæœ
        function triggerAvatarChange() {
          if (!avatarContainer || !avatarImage || isAvatarAnimating) return;
          isAvatarAnimating = true;

          // è·å–é—®å€™è¯­å…ƒç´ å’ŒèƒŒæ™¯å®¹å™¨
          const greetingText = document.querySelector('.greeting-text') as HTMLElement;
          const greetingContainer = greetingText?.parentElement as HTMLElement;
          
          // å¼€å§‹å¤´åƒåˆ°emojiçš„åŠ¨ç”» - ä½¿ç”¨ä¸emojiç›¸åŒçš„åŠ¨ç”»é€»è¾‘
          avatarImage.style.transform = 'perspective(1000px) rotateY(25deg) rotateZ(5deg) scale(0.9)';
          avatarImage.style.opacity = '0';
          avatarImage.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
          avatarImage.style.filter = 'blur(4px) brightness(1.1)';

          // åŒæ—¶å¼€å§‹é—®å€™è¯­è¿‡æ¸¡åŠ¨ç”»
          if (greetingText && greetingContainer) {
            greetingText.style.transform = 'scale(0.9) translateZ(0)';
            greetingText.style.opacity = '0';
            greetingText.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            greetingText.style.filter = 'blur(2px) brightness(1.1)';

            greetingContainer.style.transform = 'scale(0.9) translateZ(0)';
            greetingContainer.style.opacity = '0';
            greetingContainer.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            greetingContainer.style.filter = 'blur(2px) brightness(1.1)';
          }

          setTimeout(() => {
            avatarImage.style.display = 'none';
          }, 450);

          // è¿ç»­æ˜¾ç¤º3ä¸ªemoji
          let emojiIndex = 0;
          const showNextEmoji = () => {
            if (emojiIndex >= 3) {
              // æ˜¾ç¤ºå®Œ3ä¸ªemojiåï¼Œå›åˆ°å¤´åƒ - ä½¿ç”¨ä¸emojiç›¸åŒçš„åŠ¨ç”»é€»è¾‘
              avatarImage.style.display = 'block';
              avatarImage.style.transform = 'perspective(1000px) rotateY(-25deg) rotateZ(-5deg) scale(0.9)';
              avatarImage.style.opacity = '0';
              avatarImage.style.filter = 'blur(4px) brightness(1.1)';
              
              // åŒæ—¶æ¢å¤é—®å€™è¯­ä¸ºé»˜è®¤å€¼
               if (greetingText && greetingContainer) {
                 greetingText.textContent = 'é†‰åä¸çŸ¥å¤©åœ¨æ°´';
                 greetingText.style.transform = 'scale(0.9) translateZ(0)';
                 greetingText.style.opacity = '0';
                 greetingText.style.filter = 'blur(2px) brightness(1.1)';

                 greetingContainer.style.transform = 'scale(0.9) translateZ(0)';
                 greetingContainer.style.opacity = '0';
                 greetingContainer.style.filter = 'blur(2px) brightness(1.1)';
               }
              
              setTimeout(() => {
                avatarImage.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(5deg) scale(1.2)';
                avatarImage.style.opacity = '1';
                avatarImage.style.filter = 'blur(0px) brightness(1)';
                avatarImage.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // åŒæ—¶æ˜¾ç¤ºé—®å€™è¯­
                 if (greetingText && greetingContainer) {
                   greetingText.style.transform = 'scale(1.2) translateZ(0)';
                   greetingText.style.opacity = '1';
                   greetingText.style.filter = 'blur(0px) brightness(1)';
                   greetingText.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                   greetingContainer.style.transform = 'scale(1.2) translateZ(0)';
                   greetingContainer.style.opacity = '1';
                   greetingContainer.style.filter = 'blur(0px) brightness(1)';
                   greetingContainer.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                 }
                
                setTimeout(() => {
                  avatarImage.style.transform = 'perspective(1000px) rotateY(5deg) rotateZ(-3deg) scale(0.95)';
                  avatarImage.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                  
                  // åŒæ—¶è°ƒæ•´é—®å€™è¯­
                   if (greetingText && greetingContainer) {
                     greetingText.style.transform = 'scale(0.95) translateZ(0)';
                     greetingText.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

                     greetingContainer.style.transform = 'scale(0.95) translateZ(0)';
                     greetingContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                   }
                  
                  setTimeout(() => {
                    avatarImage.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(1deg) scale(1)';
                    avatarImage.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    // åŒæ—¶è°ƒæ•´é—®å€™è¯­
                     if (greetingText && greetingContainer) {
                       greetingText.style.transform = 'scale(1) translateZ(0)';
                       greetingText.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                       greetingContainer.style.transform = 'scale(1) translateZ(0)';
                       greetingContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                     }
                    
                    // æ·»åŠ ä¸€ä¸ªæŒç»­çš„è½»å¾®æ—‹è½¬åŠ¨ç”»
                    setTimeout(() => {
                      avatarImage.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(0deg) scale(1)';
                      avatarImage.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                      
                      // åŒæ—¶è°ƒæ•´é—®å€™è¯­
                       if (greetingText && greetingContainer) {
                         greetingText.style.transform = 'scale(1)';
                         greetingText.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                         
                         greetingContainer.style.transform = 'scale(1)';
                         greetingContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                       }
                      
                      isAvatarAnimating = false;
                    }, 200);
                  }, 200);
                }, 300);
              }, 100);
              return;
            }

            // åˆ›å»ºå¹¶æ˜¾ç¤ºå½“å‰emoji - ä½¿ç”¨3Dé€è§†æ•ˆæœ
            const emoji = document.createElement('div') as HTMLElement;
            emoji.textContent = emojis[(currentEmojiIndex + emojiIndex) % emojis.length];
            emoji.className = 'absolute inset-0 flex items-center justify-center text-[115px] transform-gpu';
            emoji.style.transform = 'perspective(1000px) rotateY(-25deg) scale(0.7)';
            emoji.style.opacity = '0';
            emoji.style.filter = 'blur(4px) brightness(1.1)';
            emoji.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            emoji.style.userSelect = 'none'; // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
            emoji.style.cursor = 'pointer'; // è®¾ç½®æŒ‡é’ˆæ ·å¼
            // å°†emojiæ·»åŠ åˆ°é¼ æ ‡è·Ÿéšwrapperä¸­ï¼Œè¿™æ ·ä¹Ÿä¼šè·Ÿéšé¼ æ ‡ç§»åŠ¨
            mouseWrapper?.appendChild(emoji);

            // åŒæ—¶æ›´æ–°é—®å€™è¯­
             const greetingIndex = (currentEmojiIndex + emojiIndex) % greetings.length;
             if (greetingText && greetingContainer) {
               greetingText.textContent = greetings[greetingIndex];
               greetingText.style.transform = 'scale(0.7) translateZ(0)';
               greetingText.style.opacity = '0';
               greetingText.style.filter = 'blur(2px) brightness(1.1)';
               greetingText.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

               greetingContainer.style.transform = 'scale(0.7) translateZ(0)';
               greetingContainer.style.opacity = '0';
               greetingContainer.style.filter = 'blur(2px) brightness(1.1)';
               greetingContainer.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
             }

            // æ˜¾ç¤ºemojiåŠ¨ç”» - ä½¿ç”¨3Dé€è§†æ•ˆæœå’Œè½»å¾®æ—‹è½¬
            setTimeout(() => {
              emoji.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(5deg) scale(1.2)';
              emoji.style.opacity = '1';
              emoji.style.filter = 'blur(0px) brightness(1)';
              emoji.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
              
              // åŒæ—¶æ˜¾ç¤ºé—®å€™è¯­
               if (greetingText && greetingContainer) {
                 greetingText.style.transform = 'scale(1.2) translateZ(0)';
                 greetingText.style.opacity = '1';
                 greetingText.style.filter = 'blur(0px) brightness(1)';
                 greetingText.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                 greetingContainer.style.transform = 'scale(1.2) translateZ(0)';
                 greetingContainer.style.opacity = '1';
                 greetingContainer.style.filter = 'blur(0px) brightness(1)';
                 greetingContainer.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
               }
              
              setTimeout(() => {
                emoji.style.transform = 'perspective(1000px) rotateY(5deg) rotateZ(-3deg) scale(0.95)';
                emoji.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // åŒæ—¶è°ƒæ•´é—®å€™è¯­
                 if (greetingText && greetingContainer) {
                   greetingText.style.transform = 'scale(0.95) translateZ(0)';
                   greetingText.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

                   greetingContainer.style.transform = 'scale(0.95) translateZ(0)';
                   greetingContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                 }
                
                setTimeout(() => {
                  emoji.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(1deg) scale(1)';
                  emoji.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                  
                  // åŒæ—¶è°ƒæ•´é—®å€™è¯­
                   if (greetingText && greetingContainer) {
                     greetingText.style.transform = 'scale(1) translateZ(0)';
                     greetingText.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                     greetingContainer.style.transform = 'scale(1) translateZ(0)';
                     greetingContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                   }

                  // æ·»åŠ ä¸€ä¸ªæŒç»­çš„è½»å¾®æ—‹è½¬åŠ¨ç”»
                  setTimeout(() => {
                    emoji.style.transform = 'perspective(1000px) rotateY(0deg) rotateZ(0deg) scale(1)';
                    emoji.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

                    // é—®å€™è¯­ä¿æŒæ˜¾ç¤ºçŠ¶æ€
                  }, 200);
                }, 200);
              }, 300);
            }, 50);

            // éšè—å½“å‰emojiå¹¶æ˜¾ç¤ºä¸‹ä¸€ä¸ª - å‚ç…§å¤´åƒæ¶ˆå¤±åŠ¨ç”»å¹¶æ·»åŠ è½»å¾®æ—‹è½¬
            setTimeout(() => {
              emoji.style.transform = 'perspective(1000px) rotateY(25deg) rotateZ(5deg) scale(0.9)';
              emoji.style.opacity = '0';
              emoji.style.filter = 'blur(4px) brightness(1.1)';
              emoji.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

              // åŒæ—¶éšè—é—®å€™è¯­
               if (greetingText && greetingContainer) {
                 greetingText.style.transform = 'scale(0.9) translateZ(0)';
                 greetingText.style.opacity = '0';
                 greetingText.style.filter = 'blur(2px) brightness(1.1)';
                 greetingText.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                 greetingContainer.style.transform = 'scale(0.9) translateZ(0)';
                 greetingContainer.style.opacity = '0';
                 greetingContainer.style.filter = 'blur(2px) brightness(1.1)';
                 greetingContainer.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
               }
              
              setTimeout(() => {
                emoji.remove();
                emojiIndex++;
                // å¢åŠ å»¶è¿Ÿï¼Œè®©æ¶ˆå¤±åŠ¨ç”»æœ‰æ›´è‡ªç„¶çš„åœé¡¿æ„Ÿ
                setTimeout(() => {
                  showNextEmoji();
                }, 400);
              }, 550);
            }, 3000); // æ¯ä¸ªemojiæ˜¾ç¤º3ç§’
          };

          // å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€ä¸ªemoji
          setTimeout(() => {
            showNextEmoji();
          }, 600); // æ¢å¤åŸæ¥çš„å¤´åƒæ¶ˆå¤±åçš„ç­‰å¾…æ—¶é—´

          // æ›´æ–°emojiç´¢å¼•ï¼Œä¸‹æ¬¡ä»å¤´å¼€å§‹
          currentEmojiIndex = (currentEmojiIndex + 3) % emojis.length;
        }

        // æ¯8ç§’è§¦å‘ä¸€æ¬¡å¤´åƒåˆ‡æ¢ï¼ˆç¬¬ä¸€æ¬¡3ç§’åè§¦å‘ï¼‰
        matrixTimeout = setTimeout(() => {
          triggerAvatarChange();
          avatarInterval = setInterval(triggerAvatarChange, 8000) as unknown as number;
        }, 3000) as unknown as number;
        
      }

      // æ¸…ç†å‡½æ•°
      function cleanup() {
        if (matrixInterval) clearInterval(matrixInterval);
        if (avatarInterval) clearInterval(avatarInterval);
        if (matrixTimeout) clearTimeout(matrixTimeout);
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
      }

      // åˆå§‹åŒ–
      initMatrixEffects();
      
      // é€‚é… ClientRouter
      document.addEventListener('astro:page-load', initMatrixEffects);
      document.addEventListener('astro:before-preparation', cleanup);
    </script>
    
  </div>

  <!-- éŸ³ä¹å¡ç‰‡ -->
  <div class="music-card-wrapper p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4 flex items-center justify-between">
      <span>éŸ³ä¹</span>
      <!-- æ’­æ”¾æŒ‡ç¤ºå™¨ - éŸ³é¢‘æ³¢å½¢ -->
      <div id="playing-indicator" class="flex items-end gap-0.5 opacity-0 transition-opacity duration-300 pointer-events-none">
        <div class="w-1 h-3 bg-primary-light dark:bg-primary-dark rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
        <div class="w-1 h-4 bg-primary-light dark:bg-primary-dark rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
        <div class="w-1 h-3 bg-primary-light dark:bg-primary-dark rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
      </div>
    </h3>

    <div class="music-card-content">
      <!-- æ­Œå•å°é¢å’Œä¿¡æ¯ -->
      <div class="flex gap-4 mb-4">
        <!-- å°é¢å›¾ -->
        <div class="relative w-24 h-24 flex-shrink-0 group">
          <!-- å°é¢å›¾ç‰‡ -->
          <img
            src="/img/music-cover.webp"
            alt="æ­Œå•å°é¢"
            class="w-full h-full object-cover rounded-2xl shadow-lg relative z-10"
            id="playlist-cover"
            onerror="this.src='https://picsum.photos/200/200?blur'"
          />
        </div>

        <!-- æ­Œå•ä¿¡æ¯ -->
        <div class="flex-1 min-w-0 flex flex-col justify-between">
          <div>
            <h4 class="text-sm font-bold text-text-light dark:text-text-dark mb-1 line-clamp-2" id="playlist-name">æˆ‘çš„æ­Œå•</h4>
            <p class="text-xs text-text-light dark:text-text-dark opacity-60" id="playlist-count">åŠ è½½ä¸­...</p>
            <p class="text-xs text-primary-light dark:text-primary-dark mt-1 truncate" id="current-song">æœªæ’­æ”¾</p>
          </div>
          <div class="flex items-center gap-2">
            <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
            <button onclick="playPrev()" class="p-1.5 rounded-lg hover:bg-hover-light dark:hover:bg-hover-dark transition-colors" title="ä¸Šä¸€é¦–">
              <svg class="w-4 h-4 text-text-light dark:text-text-dark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/>
              </svg>
            </button>
            <button onclick="togglePlay()" class="p-1.5 rounded-lg hover:bg-hover-light dark:hover:bg-hover-dark transition-colors" title="æ’­æ”¾/æš‚åœ">
              <svg id="control-play-icon" class="w-4 h-4 text-text-light dark:text-text-dark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
              </svg>
              <svg id="control-pause-icon" class="w-4 h-4 text-text-light dark:text-text-dark hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button onclick="playNext()" class="p-1.5 rounded-lg hover:bg-hover-light dark:hover:bg-hover-dark transition-colors" title="ä¸‹ä¸€é¦–">
              <svg class="w-4 h-4 text-text-light dark:text-text-dark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M11.555 5.168A1 1 0 0010 6v2.798L4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- æ’­æ”¾è¿›åº¦æ¡ -->
      <div>
        <div class="h-1 bg-hover-light dark:bg-hover-dark rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-gradient-to-r from-primary-light to-primary-dark dark:from-primary-dark dark:to-purple-500 rounded-full transition-all duration-100" style="width: 0%"></div>
        </div>
        <div class="flex justify-between mt-1">
          <span id="current-time" class="text-xs text-text-light dark:text-text-dark opacity-50">0:00</span>
          <span id="total-time" class="text-xs text-text-light dark:text-text-dark opacity-50">0:00</span>
        </div>
      </div>
    </div>

    <!-- éšè—çš„ APlayer å®¹å™¨ï¼ˆç”¨äºå®é™…æ’­æ”¾ï¼‰ -->
    <div id="hidden-aplayer" style="display: none;"></div>
  </div>

  <style is:global>
    /* APlayer éšè—æ ·å¼ */
    #hidden-aplayer {
      position: absolute !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* éŸ³é¢‘æ³¢å½¢åŠ¨ç”»ä¼˜åŒ– */
    #playing-indicator > div {
      animation-duration: 0.8s;
      animation-iteration-count: infinite;
    }
  </style>

  <!-- åˆ†ç±»å¡ç‰‡ -->
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">åˆ†ç±»</h3>
    <ul class="space-y-2">
      {sortedCategories.map(([category, count]) => (
        <li>
          <a href={`/category/${category}`} class="flex items-center justify-between px-3 py-2 rounded-3xl text-sm font-medium text-text-light hover:text-text-light hover:bg-hover-light dark:text-text-dark dark:hover:text-text-dark dark:hover:bg-hover-dark">
            {category}
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium bg-badge-light text-text-light dark:bg-badge-dark dark:text-text-dark">{count}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>

  <!-- ä¸€è¨€å¡ç‰‡ -->
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">ä¸€è¨€</h3>
    <div class="min-h-[100px] flex items-center justify-center p-2">
      <p class="hitokoto-text text-sm text-text-light dark:text-text-dark text-center leading-relaxed italic opacity-80 w-full">åŠ è½½ä¸­...</p>
    </div>
    <p class="hitokoto-from text-xs text-text-light dark:text-text-dark opacity-50 text-center mt-3 min-h-[1em]"></p>
  </div>

  <!-- æœ€è¿‘åœ¨çœ‹å¡ç‰‡ -->
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">æœ€è¿‘åœ¨çœ‹</h3>
    <div class="space-y-4">
      {watchingList.slice(0, 3).map((item) => (
        <div class="flex gap-3 group items-center">
          <div class="w-16 h-20 flex-shrink-0 rounded-xl overflow-hidden bg-hover-light dark:bg-hover-dark">
            <img
              src={item.cover}
              alt={item.title}
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
              loading="lazy"
            />
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="text-sm font-semibold text-text-light dark:text-text-dark mb-1 line-clamp-1 group-hover:text-primary-light dark:group-hover:text-primary-dark transition-colors">
              {item.title}
            </h4>
            <div class="flex items-center gap-2 mb-1.5">
              <span class="text-xs px-1.5 py-0.5 rounded bg-primary-light/10 text-primary-light dark:bg-primary-dark/10 dark:text-primary-dark">
                {item.type === 'movie' ? 'ç”µå½±' : item.type === 'anime' ? 'åŠ¨ç”»' : 'ä¹¦ç±'}
              </span>
              <span class="text-xs text-text-light dark:text-text-dark opacity-50">{item.year}</span>
              <div class="flex items-center gap-1">
                <span class="text-yellow-500">â˜…</span>
                <span class="text-xs font-medium text-yellow-600 dark:text-yellow-400">{item.rating}</span>
              </div>
            </div>
            <p class="text-xs text-text-light dark:text-text-dark opacity-70 line-clamp-2">
              {item.comment}
            </p>
          </div>
        </div>
      ))}
    </div>
  </div>
</aside>

<script is:inline>
  async function fetchHitokoto() {
    try {
      const response = await fetch('https://v1.hitokoto.cn');
      const data = await response.json();
      const textEls = document.querySelectorAll('.hitokoto-text');
      const fromEls = document.querySelectorAll('.hitokoto-from');

      textEls.forEach(el => el.textContent = data.hitokoto);
      fromEls.forEach(el => el.textContent = data.from ? `â€”â€” ${data.from}` : '');
    } catch (error) {
      console.error('Failed to fetch hitokoto:', error);
      document.querySelectorAll('.hitokoto-text').forEach(el => {
        el.textContent = 'é†‰åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚';
      });
    }
  }

  // ç›´æ¥æ‰§è¡Œ
  fetchHitokoto();

  // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
  setInterval(fetchHitokoto, 30000);

  // å¤„ç† ViewTransitions
  document.addEventListener('astro:after-swap', fetchHitokoto);
</script>

<script is:inline>
  // éŸ³ä¹å¡ç‰‡æ’­æ”¾æ§åˆ¶
  (function() {
    // å…¨å±€çŠ¶æ€ç®¡ç†
    window.musicPlayerState = window.musicPlayerState || {
      ap: null,
      songsData: [],
      isInitialized: false,
      updateTimer: null
    };

    let ap = window.musicPlayerState.ap;
    let songsData = window.musicPlayerState.songsData;
    let updateTimer = window.musicPlayerState.updateTimer;

    // åŠ è½½ APlayer
    function loadAPlayer() {
      return new Promise((resolve, reject) => {
        if (typeof APlayer !== 'undefined') {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // åˆå§‹åŒ–æ’­æ”¾å™¨
    async function initPlayer() {
      // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥è¿”å›
      if (window.musicPlayerState.isInitialized && ap) {
        return;
      }

      try {
        await loadAPlayer();

        // è·å–æ­Œå•æ•°æ®
        const response = await fetch('https://api.injahow.cn/meting/?type=playlist&id=2732533345&server=netease&limit=50');
        const data = await response.json();

        if (!data || data.length === 0) {
          console.error('Failed to fetch playlist');
          return;
        }

        songsData = data;

        // æ›´æ–°æ­Œæ›²æ•°é‡
        const countEl = document.getElementById('playlist-count');
        if (countEl) {
          countEl.textContent = `${data.length} é¦–æ­Œæ›²`;
        }

        // æ›´æ–°æ­Œå•åç§°ï¼ˆå¦‚æœ API è¿”å›äº†ï¼‰
        if (data[0] && data[0].playlist_name) {
          const nameEl = document.getElementById('playlist-name');
          if (nameEl) nameEl.textContent = data[0].playlist_name;
        }

        // æ›´æ–°å°é¢
        if (data[0] && data[0].pic) {
          const coverEl = document.getElementById('playlist-cover');
          if (coverEl) coverEl.src = data[0].pic;
        }

        // è½¬æ¢æ•°æ®æ ¼å¼
        const audioList = data.map(item => ({
          name: item.name || item.title || 'æœªçŸ¥æ­Œæ›²',
          artist: item.artist || item.author || 'æœªçŸ¥è‰ºæœ¯å®¶',
          url: item.url,
          cover: item.pic || item.cover || '',
          lrc: item.lrc || ''
        }));

        // åˆ›å»ºæ’­æ”¾å™¨
        ap = new APlayer({
          container: document.getElementById('hidden-aplayer'),
          autoplay: false,
          theme: '#3b82f6',
          loop: 'all',
          preload: 'auto',
          volume: 0.7,
          mutex: true,
          audio: audioList
        });

        // ä¿å­˜åˆ°å…¨å±€çŠ¶æ€
        window.musicPlayerState.ap = ap;
        window.musicPlayerState.songsData = songsData;
        window.musicPlayerState.isInitialized = true;

        // ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶
        ap.on('play', () => window.musicPlayerUpdateUI?.());
        ap.on('pause', () => window.musicPlayerUpdateUI?.());
        ap.on('timeupdate', () => window.musicPlayerUpdateProgress?.());

        // å¯åŠ¨å®šæœŸæ›´æ–°
        startPeriodicUpdate();
      } catch (error) {
        console.error('Failed to initialize player:', error);
        const countEl = document.getElementById('playlist-count');
        if (countEl) {
          countEl.textContent = 'åŠ è½½å¤±è´¥';
        }
      }
    }

    // æ›´æ–°æ’­æ”¾çŠ¶æ€ UIï¼ˆå…¨å±€å‡½æ•°ï¼‰
    window.musicPlayerUpdateUI = function() {
      const ap = window.musicPlayerState?.ap;
      if (!ap) return;

      const isPlaying = !ap.audio.paused;
      const currentSong = ap.list.audios[ap.list.index];

      // æ›´æ–°æ’­æ”¾/æš‚åœå›¾æ ‡
      const controlPlayIcon = document.getElementById('control-play-icon');
      const controlPauseIcon = document.getElementById('control-pause-icon');
      const indicator = document.getElementById('playing-indicator');
      const currentSongEl = document.getElementById('current-song');
      const coverImg = document.getElementById('playlist-cover');

      if (isPlaying) {
        controlPlayIcon?.classList.add('hidden');
        controlPauseIcon?.classList.remove('hidden');
        // æ·¡å…¥éŸ³é¢‘æ³¢å½¢
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            indicator?.classList.remove('opacity-0');
          });
        });
        if (currentSongEl && currentSong) {
          currentSongEl.textContent = `${currentSong.name} - ${currentSong.artist}`;
        }
      } else {
        controlPlayIcon?.classList.remove('hidden');
        controlPauseIcon?.classList.add('hidden');
        // æ·¡å‡ºéŸ³é¢‘æ³¢å½¢
        indicator?.classList.add('opacity-0');
      }
    };

    // æ›´æ–°è¿›åº¦æ¡ï¼ˆå…¨å±€å‡½æ•°ï¼‰
    window.musicPlayerUpdateProgress = function() {
      const ap = window.musicPlayerState?.ap;
      if (!ap) return;

      const progressBar = document.getElementById('progress-bar');
      const currentTimeEl = document.getElementById('current-time');
      const totalTimeEl = document.getElementById('total-time');

      if (progressBar) {
        const percent = (ap.audio.currentTime / ap.audio.duration) * 100 || 0;
        progressBar.style.width = `${percent}%`;
      }

      if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(ap.audio.currentTime);
      }

      if (totalTimeEl) {
        totalTimeEl.textContent = formatTime(ap.audio.duration || 0);
      }
    };

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // å¯åŠ¨å®šæœŸæ›´æ–°ï¼ˆç¡®ä¿é¡µé¢åˆ‡æ¢åUIä»ç„¶æ›´æ–°ï¼‰
    function startPeriodicUpdate() {
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        window.musicPlayerUpdateUI?.();
        window.musicPlayerUpdateProgress?.();
      }, 100);
      window.musicPlayerState.updateTimer = updateTimer;
    }

    // æ’­æ”¾/æš‚åœ
    window.togglePlay = function() {
      const ap = window.musicPlayerState?.ap;
      if (!ap || !ap.list.audios.length) return;
      if (ap.audio.paused) {
        ap.play();
      } else {
        ap.pause();
      }
    };

    // ä¸Šä¸€é¦–
    window.playPrev = function() {
      const ap = window.musicPlayerState?.ap;
      if (!ap || !ap.list.audios.length) return;
      ap.list.switch(ap.list.index - 1 < 0 ? ap.list.audios.length - 1 : ap.list.index - 1);
      ap.play();
    };

    // ä¸‹ä¸€é¦–
    window.playNext = function() {
      const ap = window.musicPlayerState?.ap;
      if (!ap || !ap.list.audios.length) return;
      ap.list.switch(ap.list.index + 1 >= ap.list.audios.length ? 0 : ap.list.index + 1);
      ap.play();
    };

    // åˆå§‹åŒ–
    if (!window.musicPlayerState.isInitialized) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPlayer);
      } else {
        initPlayer();
      }
    } else {
      // å·²ç»åˆå§‹åŒ–è¿‡ï¼Œæ¢å¤ UI çŠ¶æ€
      startPeriodicUpdate();
      window.musicPlayerUpdateUI?.();
      window.musicPlayerUpdateProgress?.();
    }

    // å¤„ç† ViewTransitions - é¡µé¢åˆ‡æ¢åæ¢å¤ UI
    document.addEventListener('astro:after-swap', () => {
      // ç¡®ä¿å®šæœŸæ›´æ–°åœ¨è¿è¡Œ
      startPeriodicUpdate();
      // ç«‹å³æ›´æ–°ä¸€æ¬¡ UI
      window.musicPlayerUpdateUI?.();
      window.musicPlayerUpdateProgress?.();

      // æ¢å¤é™æ€ä¿¡æ¯ï¼ˆæ­Œå•æ•°é‡ã€åç§°ã€å°é¢ï¼‰
      const songsData = window.musicPlayerState?.songsData;
      if (songsData && songsData.length > 0) {
        // æ›´æ–°æ­Œæ›²æ•°é‡
        const countEl = document.getElementById('playlist-count');
        if (countEl) {
          countEl.textContent = `${songsData.length} é¦–æ­Œæ›²`;
        }

        // æ›´æ–°æ­Œå•åç§°
        if (songsData[0] && songsData[0].playlist_name) {
          const nameEl = document.getElementById('playlist-name');
          if (nameEl) nameEl.textContent = songsData[0].playlist_name;
        }

        // æ›´æ–°æ­Œå•å°é¢
        if (songsData[0] && songsData[0].pic) {
          const coverEl = document.getElementById('playlist-cover');
          if (coverEl) coverEl.src = songsData[0].pic;
        }
      }

      // é‡æ–°è·å–å¹¶æ›´æ–°å½“å‰æ­Œæ›²å°é¢ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      const ap = window.musicPlayerState?.ap;
      if (ap && ap.list.audios.length > 0) {
        const currentSong = ap.list.audios[ap.list.index];
        const coverEl = document.getElementById('playlist-cover');
        if (coverEl && currentSong?.cover) {
          coverEl.src = currentSong.cover;
        }
      }
    });
  })();
</script>
