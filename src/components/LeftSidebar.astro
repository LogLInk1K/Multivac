---
import { getCollection } from 'astro:content';

const posts = await getCollection('post');

const categories = posts.reduce((acc, post) => {
  const category = post.data.category;
  if (category) {
    acc[category] = (acc[category] || 0) + 1;
  }
  return acc;
}, {} as Record<string, number>);

const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<aside class="hidden md:block w-[272px] space-y-6">
  <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
  <div class="p-4 h-[300px] bg-primary-light dark:bg-primary-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 matrix-card relative overflow-hidden">
    <!-- é¡¶éƒ¨ï¼š1k.ink æ–‡æœ¬ -->
    <div class="absolute top-4 left-0 right-0 flex justify-center">
      <div class="px-3 py-1 bg-white/20 dark:bg-black/50 rounded-full">
        <span class="text-sm font-medium text-white greeting-text">1k.ink</span>
      </div>
    </div>
    <!-- ä¸­é—´ï¼šå¤´åƒ -->
    <div class="absolute top-0 left-0 right-0 bottom-0 flex justify-center items-center pt-12 pb-16">
      <div class="relative avatar-container">
        <img 
          src="https://thirdqq.qlogo.cn/g?b=sdk&k=h55tiaaAAKPaziaDJ8NNkIzA&s=640&t=1627665755" 
          alt="åšä¸»å¤´åƒ" 
          class="w-[115px] rounded-full object-cover border-4 border-white dark:border-white shadow-lg avatar-image"
        />
      </div>
    </div>
    <!-- åº•éƒ¨ï¼šä¿¡æ¯åŒº -->
    <div class="absolute bottom-4 left-4 right-4 flex justify-between items-center">
      <!-- å·¦ä¾§ï¼šåšä¸»ä¿¡æ¯å®¹å™¨ -->
      <a href="/about" class="text-container block hover:opacity-85 transition-opacity duration-200">
        <h2 class="text-xl font-bold text-white dark:text-black mb-1 matrix-text" data-text="æ³¢ç½—æ­Œ">æ³¢ç½—æ­Œ</h2>
        <p class="text-xs text-white dark:text-black/90 opacity-60 matrix-text" data-text="ä¸‡ç»´ç½‘ä¸­æ½®æ±›æ¥">ä¸‡ç»´ç½‘ä¸­æ½®æ±›æ¥</p>
      </a>

      <!-- å³ä¾§ï¼šç¤¾äº¤å›¾æ ‡å®¹å™¨ -->
      <div class="icons-container flex space-x-2">
        <a href="https://github.com/LogLInk1K" target="_blank" rel="noopener noreferrer" 
           class="text-white hover:text-white transition-all duration-200 hover:scale-110 relative group w-10 h-10 rounded-full bg-white/20 dark:bg-black/50 hover:bg-white/30 dark:hover:bg-black/70 flex items-center justify-center">
          <span class="sr-only">GitHub</span>
          <svg viewBox="0 0 16 16" aria-hidden="true" width="20">
            <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-white text-primary-light text-sm rounded-lg shadow-md opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none whitespace-nowrap">
            GitHub
          </div>
        </a>
        <a href="https://space.bilibili.com/12787362" target="_blank" rel="noopener noreferrer" 
           class="text-white hover:text-white transition-all duration-200 hover:scale-110 relative group w-10 h-10 rounded-full bg-white/20 dark:bg-black/50 hover:bg-white/30 dark:hover:bg-black/70 flex items-center justify-center">
          <span class="sr-only">Bilibili</span>
          <svg viewBox="0 0 24 24" aria-hidden="true" width="20">
            <path fill="currentColor" d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"></path>
          </svg>
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-white text-primary-light text-sm rounded-lg shadow-md opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none whitespace-nowrap">
            Bilibili
          </div>
        </a>
      </div>
    </div>

    <!-- Matrix Effect Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const matrixCard = document.querySelector('.matrix-card');
        const matrixTexts = matrixCard?.querySelectorAll('.matrix-text') || [];
        const matrixChars = '0123456789ABCDEFG';
        let isAnimating = false;
        let changeCount = 0; // è·Ÿè¸ªå¥‡æ•°æ¬¡/å¶æ•°æ¬¡å˜åŒ–çš„è®¡æ•°å™¨

        // æ ¹æ®æ—¶é—´è·å–é—®å€™è¯­
        function getGreeting() {
          const hour = new Date().getHours();
          if (hour >= 5 && hour < 12) {
            return 'æ—©ä¸Šå¥½ï¼Œå¤œä¹‹åŸï¼';
          } else if (hour >= 12 && hour < 14) {
            return 'çœŸé¦™ï¼';
          } else if (hour >= 14 && hour < 18) {
            return 'ä¸‰ç‚¹å‡ å“©ï¼Œé¥®èŒ¶å…ˆå•¦ï¼';
          } else if (hour >= 18 && hour < 22) {
            return 'çœŸç›¸åªæœ‰ä¸€ä¸ªï¼';
          } else {
            return 'ä½ è§è¿‡å‡Œæ™¨å››ç‚¹çš„æ´›æ‰çŸ¶å—ï¼Ÿ';
          }
        }

        // æ›´æ–°é—®å€™è¯­æ–‡æœ¬
        const greetingText = document.querySelector('.greeting-text');
        if (greetingText) {
          greetingText.textContent = getGreeting();
        }

        // Matrixæ•ˆæœå‡½æ•°
        function triggerMatrixEffect() {
          if (isAnimating || matrixTexts.length === 0) return;
          isAnimating = true;
          changeCount++;
          
          // ä¸ºæ¯ä¸ªæ–‡æœ¬å…ƒç´ æ·»åŠ åŠ¨ç”»æ•ˆæœ
          matrixTexts.forEach((element, index) => {
            const originalText = (element as HTMLElement).dataset.text || '';
            if (!originalText) return;
            const chars = originalText.split('');
            const isEvenIndex = index % 2 === 0;
            const isEvenChange = changeCount % 2 === 0;
            // æ ¹æ®ç´¢å¼•å’Œå˜åŒ–æ¬¡æ•°å…±åŒå†³å®šåŠ¨ç”»æ–¹å‘
            const shouldReverse = isEvenChange ? isEvenIndex : !isEvenIndex;
            let revealIndex = shouldReverse ? chars.length : 0;
            
            // åˆå§‹å­—ç¬¦æ‰“ä¹±
            element.textContent = chars.map(() => matrixChars[Math.floor(Math.random() * matrixChars.length)]).join('');
            
            // é€ä¸ªå­—ç¬¦åŠ¨ç”»æ˜¾ç¤º
            const scrambleInterval = setInterval(() => {
              element.textContent = element.textContent.split('').map((_, i) => {
                if (shouldReverse) {
                  // ä»å³åˆ°å·¦åŠ¨ç”»
                  return i >= revealIndex ? originalText[i] : matrixChars[Math.floor(Math.random() * matrixChars.length)];
                } else {
                  // ä»å·¦åˆ°å³åŠ¨ç”»
                  return i < revealIndex ? originalText[i] : matrixChars[Math.floor(Math.random() * matrixChars.length)];
                }
              }).join('');
              
              // æ ¹æ®åŠ¨ç”»æ–¹å‘æ›´æ–°æ˜¾ç¤ºç´¢å¼•
              if (shouldReverse) {
                revealIndex--;
                if (revealIndex < 0) {
                  clearInterval(scrambleInterval);
                  element.textContent = originalText;
                  if (index === matrixTexts.length - 1) {
                    isAnimating = false;
                  }
                }
              } else {
                revealIndex++;
                if (revealIndex > originalText.length) {
                  clearInterval(scrambleInterval);
                  element.textContent = originalText;
                  if (index === matrixTexts.length - 1) {
                    isAnimating = false;
                  }
                }
              }
            }, 50);
          });
        }
        
        // ä¸ºå¡ç‰‡å’Œæ–‡æœ¬å®¹å™¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        if (matrixCard) matrixCard.addEventListener('mouseenter', triggerMatrixEffect);
        const textContainer = matrixCard?.querySelector('.text-container');
        if (textContainer) {
          textContainer.addEventListener('mouseenter', triggerMatrixEffect);
        }

        // æ¯3ç§’è‡ªåŠ¨è§¦å‘ä¸€æ¬¡Matrixæ•ˆæœ
        const matrixInterval = setInterval(triggerMatrixEffect, 10000);
        
        // ç»„ä»¶ç§»é™¤æ—¶æ¸…ç†å®šæ—¶å™¨
        matrixCard?.addEventListener('remove', () => {
          clearInterval(matrixInterval);
        });

        // å¤´åƒåˆ‡æ¢æ•ˆæœ
        const avatarContainer = document.querySelector('.avatar-container');
        const avatarImage = document.querySelector('.avatar-image') as HTMLImageElement;
        const emojis = ['ğŸ˜‹', 'ğŸ˜¼', 'ğŸ˜', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶'];
        let currentEmojiIndex = 0;
        let isAvatarAnimating = false;

        function triggerAvatarChange() {
          if (!avatarContainer || !avatarImage || isAvatarAnimating) return;
          isAvatarAnimating = true;

          // åˆ›å»ºemojiå…ƒç´ 
          const emoji = document.createElement('div');
          emoji.textContent = emojis[currentEmojiIndex];
          emoji.className = 'absolute inset-0 flex items-center justify-center text-[115px]';
          emoji.style.transform = 'scale(0) rotate(-180deg)';
          emoji.style.opacity = '0';
          emoji.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
          avatarContainer.appendChild(emoji);

          // åŠ¨ç”»åºåˆ—
          setTimeout(() => {
            emoji.style.transform = 'scale(1) rotate(0deg)';
            emoji.style.opacity = '1';
          }, 50);

          setTimeout(() => {
            avatarImage.style.transform = 'scale(0) rotate(180deg)';
            avatarImage.style.opacity = '0';
            avatarImage.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
          }, 100);

          setTimeout(() => {
            avatarImage.style.display = 'none';
          }, 600);

          setTimeout(() => {
            emoji.style.transform = 'scale(0) rotate(180deg)';
            emoji.style.opacity = '0';
            avatarImage.style.display = 'block';
            avatarImage.style.transform = 'scale(0) rotate(-180deg)';
          }, 2000);

          setTimeout(() => {
            avatarImage.style.transform = 'scale(1) rotate(0deg)';
            avatarImage.style.opacity = '1';
            emoji.remove();
            isAvatarAnimating = false;
            currentEmojiIndex = (currentEmojiIndex + 1) % emojis.length;
          }, 2300);
        }

        // æ¯5ç§’è§¦å‘ä¸€æ¬¡å¤´åƒåˆ‡æ¢ï¼ˆç¬¬ä¸€æ¬¡3ç§’åè§¦å‘ï¼‰
        setTimeout(() => {
          triggerAvatarChange();
          const avatarInterval = setInterval(triggerAvatarChange, 5000);
          
          // ç»„ä»¶ç§»é™¤æ—¶æ¸…ç†å®šæ—¶å™¨
          matrixCard?.addEventListener('remove', () => {
            clearInterval(avatarInterval);
          });
        }, 3000);
      });
    </script>
    
  </div>

  <!-- å…¬å‘Šå¡ç‰‡ -->
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">å…¬å‘Š</h3>
    <div class="space-y-4">
      <!-- ç¬¬ä¸€æ®µï¼šè™«æ´å›¾ç‰‡ -->
      <div>
        <a href="https://www.foreverblog.cn/go.html" target="_blank" rel="noopener noreferrer">
          <!-- æµ…è‰²ä¸»é¢˜è™«æ´å›¾ç‰‡ -->
          <img 
            src="https://foreverblog.cn/assets/logo/wormhole_4_tp.gif" 
            alt="è™«æ´" 
            class="w-1/2 h-auto dark:hidden cursor-pointer"
          />
          <!-- æ·±è‰²ä¸»é¢˜è™«æ´å›¾ç‰‡ -->
          <img 
            src="https://foreverblog.cn/assets/logo/wormhole_2_tp.gif" 
            alt="è™«æ´" 
            class="w-1/2 h-auto hidden dark:block cursor-pointer"
          />
        </a>
      </div>
      <!-- ç¬¬äºŒæ®µï¼šæ–‡å­—è¯´æ˜ -->
      <p class="text-sm text-text-light dark:text-text-dark">
        ç©¿æ¢­è™«æ´-éšæœºè®¿é—®åå¹´ä¹‹çº¦å‹é“¾åšå®¢
      </p>
      <!-- ç¬¬ä¸‰æ®µï¼šlogoå›¾ç‰‡ -->
      <div>
        <a href="https://www.foreverblog.cn" target="_blank" rel="noopener noreferrer">
          <img 
            src="https://www.foreverblog.cn/assets/logo/logo_en_default.png" 
            alt="åå¹´ä¹‹çº¦" 
            class="w-1/2 h-auto cursor-pointer"
          />
        </a>
      </div>
      <!-- ç¬¬å››æ®µï¼šæ´»åŠ¨è¯´æ˜ -->
      <p class="text-sm text-text-light dark:text-text-dark">
        æœ¬åšå®¢å·²åŠ å…¥åå¹´ä¹‹çº¦æ´»åŠ¨
      </p>
    </div>
  </div>

  <!-- åˆ†ç±»å¡ç‰‡ -->
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">åˆ†ç±»</h3>
    <ul class="space-y-2">
      {sortedCategories.map(([category, count]) => (
        <li>
          <a href={`/category/${category}`} class="flex items-center justify-between px-3 py-2 rounded-3xl text-sm font-medium text-text-light hover:text-text-light hover:bg-hover-light dark:text-text-dark dark:hover:text-text-dark dark:hover:bg-hover-dark">
            {category}
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium bg-badge-light text-text-light dark:bg-badge-dark dark:text-text-dark">{count}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>
</aside>
