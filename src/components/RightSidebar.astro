---
import { getCollection } from 'astro:content';
import FormattedDate from './FormattedDate.astro';

const posts = await getCollection('post');

// 1. æ ‡ç­¾é€»è¾‘å¤„ç†
const allTags = posts.reduce((acc, post) => {
  const tags = post.data.tags || [];
  tags.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const sortedTags = Object.entries(allTags).sort((a, b) => b[1] - a[1]);
const randomTags = [...sortedTags].sort(() => Math.random() - 0.5).slice(0, 10);

// 2. å‡†å¤‡æ‰€æœ‰æ–‡ç« çš„ç²¾ç®€æ•°æ®ä¾›å‰ç«¯éšæœºæŠ½å–
interface PostSummary {
  id: string;
  title: string;
  pubDate: string;
  heroImage?: string | { src: string };
  category?: string;
}

const postSummaries: PostSummary[] = posts.map(post => ({
  id: post.id,
  title: post.data.title,
  pubDate: post.data.pubDate.toISOString(),
  heroImage: post.data.heroImage,
  category: post.data.category,
}));

// åˆå§‹æ˜¾ç¤ºçš„ 5 ç¯‡æ–‡ç« 
const initialRandomPosts = [...posts].sort(() => Math.random() - 0.5).slice(0, 3);
---

<aside class="hidden md:block w-[272px] space-y-6">
  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider">éšæœºæ¨è</h3>
      <button
        type="button"
        class="js-refresh-trigger group relative p-1.5 rounded-full text-text-light dark:text-text-dark hover:text-primary-light dark:hover:text-primary-dark transition-colors focus:outline-none active:scale-90"
        data-posts={JSON.stringify(postSummaries)}
        aria-label="åˆ·æ–°æ¨è"
      >
        <svg class="w-6 h-6 transition-all duration-300 group-hover:scale-75 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
          <div class="bg-primary-light dark:bg-primary-dark rounded-full px-1 py-1">
            <svg class="w-6 h-6 text-white dark:text-black pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </div>
        </div>
      </button>
    </div>
    <ul class="js-posts-list-container space-y-4 transition-opacity duration-200">
      {initialRandomPosts.map((post) => (
        <li>
          <a href={`/post/${post.id}`} class="block group py-2 rounded-3xl hover:scale-105 transition-all duration-200">
            <div class="flex gap-3 items-center">
              {post.data.heroImage && (
                <div class="w-16 h-16 flex-shrink-0 bg-hero-light dark:bg-hero-dark rounded-xl overflow-hidden">
                  <div
                    class="w-full h-full bg-cover bg-center"
                    style={`background-image: url('${typeof post.data.heroImage === 'string' ? post.data.heroImage : post.data.heroImage.src}');`}
                    aria-label={post.data.title}
                  ></div>
                </div>
              )}
              <div class="flex-1 min-w-0">
                <p class="text-xs text-text-light dark:text-text-dark opacity-50">
                  <FormattedDate date={post.data.pubDate} />
                  {post.data.category && (
                    <>
                      <span class="mx-1.5">{post.data.category}</span>
                    </>
                  )}
                </p>
                <p class="text-sm font-medium text-text-light dark:text-text-dark group-hover:text-primary-light dark:group-hover:text-primary-dark transition-colors line-clamp-2 mt-1">{post.data.title}</p>
              </div>
            </div>
          </a>
        </li>
      ))}
    </ul>
  </div>

  <div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4">æ ‡ç­¾</h3>
    <div class="flex flex-wrap gap-2">
      {randomTags.map(([tag, count]) => (
        <a href={`/tag/${tag}`} class="inline-flex items-center rounded-full text-xs font-medium overflow-hidden hover:scale-105 transition-all duration-200">
          <span class="px-3 py-1 bg-badge-light text-text-light dark:bg-badge-dark dark:text-text-dark">{tag}</span>
          <span class="px-2 py-1 bg-divider-light text-text-light dark:bg-divider-dark dark:text-text-dark opacity-60">{count}</span>
        </a>
      ))}
    </div>
  </div>

<div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
    <h3 class="text-base font-semibold text-text-light dark:text-text-dark uppercase tracking-wider mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-[#f26522]" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248S0 22.546 0 20.752s1.456-3.248 3.252-3.248 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-8.18v4.831c10.555.062 19.121 8.614 19.184 19.17h4.817c-.063-13.215-10.782-23.93-24.001-24.001z"></path>
      </svg>
      RSS è®¢é˜…
    </h3>
    <p class="text-sm text-text-light/70 dark:text-text-dark/70 mb-4 leading-relaxed">è·å–æœ€ç›´æ¥çš„æ–‡ç« æ¨é€ï¼Œæ”¯æŒä¸»æµé˜…è¯»å™¨ã€‚</p>
    
<div class="flex items-stretch h-9 group/rss">
  <div class="flex-grow flex items-center px-3 border-y border-l border-border-light dark:border-border-dark rounded-l-xl bg-background-light dark:bg-background-dark min-w-0">
    <span class="text-[11px] font-mono text-text-light/50 dark:text-text-dark/50 truncate select-all">
      https://log.1k.ink/rss.xml
    </span>
  </div>

  <button
    data-clipboard-text="https://log.1k.ink/rss.xml"
    onclick="
      const self = this;
      const icon = self.querySelector('.copy-icon');
      const text = self.querySelector('.success-msg');
      
      // åˆ‡æ¢çŠ¶æ€
      icon.classList.add('hidden');
      text.classList.remove('hidden');
      
      navigator.clipboard.writeText(self.getAttribute('data-clipboard-text')).then(() => {
        setTimeout(() => {
          // 2ç§’åè¿˜åŸ
          icon.classList.remove('hidden');
          text.classList.add('hidden');
        }, 2000);
      });
    "
    class="w-12 h-9 flex items-center justify-center bg-primary-light dark:bg-primary-dark hover:bg-primary-light/80 dark:hover:bg-[#e6ad26] transition-all duration-300 ease-in-out rounded-r-xl flex-shrink-0 group/btn"
  >
    <svg class="copy-icon w-4 h-4 text-white dark:text-black transition-transform duration-200 group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
    </svg>

    <span class="success-msg hidden text-sm">ğŸ˜‹</span>
  </button>
</div>
    
    <p class="mt-4 text-[10px] text-text-light dark:text-text-dark opacity-40 italic">æ”¯æŒ Feedlyã€Inoreaderã€Reeder ç­‰</p>
  </div>
</aside>

<script is:inline>
  (function() {
    /**
     * æ‰§è¡Œåˆ·æ–°é€»è¾‘
     * @param {HTMLElement} btn æŒ‰é’®å…ƒç´ 
     */
    function refresh(btn) {
      const cardContainer = btn.closest('div').parentElement;
      const listContainer = cardContainer.querySelector('.js-posts-list-container');
      const rawData = btn.getAttribute('data-posts');

      if (!listContainer || !rawData) return;

      // 1. å¼€å§‹æ·¡å‡º
      listContainer.style.opacity = '0';

      setTimeout(() => {
        try {
          const allPosts = JSON.parse(rawData);
          // ä½¿ç”¨ Fisher-Yates éšæœºç®—æ³•æ´—ç‰Œ
          const shuffled = [...allPosts];
          for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }
          const selected = shuffled.slice(0, 3);

          // 2. æ›´æ–° HTML å†…å®¹
          listContainer.innerHTML = selected.map(post => {
            const date = new Date(post.pubDate).toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            });

            const heroImageHtml = post.heroImage ? `
              <div class="w-16 h-16 flex-shrink-0 bg-hero-light dark:bg-hero-dark rounded-xl overflow-hidden">
                <div
                  class="w-full h-full bg-cover bg-center"
                  style="background-image: url('${typeof post.heroImage === 'string' ? post.heroImage : post.heroImage.src}');"
                  aria-label="${post.title}"
                ></div>
              </div>
            ` : '';

            const categoryHtml = post.category ? `
              <span class="mx-1.5">${post.category}</span>
            ` : '';

            return `
              <li>
                <a href="/post/${post.id}" class="block group py-2 rounded-3xl hover:scale-105 transition-all duration-200">
                  <div class="flex gap-3 items-center">
                    ${heroImageHtml}
                    <div class="flex-1 min-w-0">
                      <p class="text-xs text-text-light dark:text-text-dark opacity-50">
                        ${date}
                        ${categoryHtml}
                      </p>
                      <p class="text-sm font-medium text-text-light dark:text-text-dark group-hover:text-primary-light dark:group-hover:text-primary-dark transition-colors line-clamp-2 mt-1">${post.title}</p>
                    </div>
                  </div>
                </a>
              </li>
            `;
          }).join('');

          // 3. å¼€å§‹æ·¡å…¥
          listContainer.style.opacity = '1';
        } catch (e) {
          console.error('[RandomPosts] Refresh error:', e);
          listContainer.style.opacity = '1';
        }
      }, 200);
    }

    /**
     * å¤„ç†ç‚¹å‡»äº‹ä»¶å†’æ³¡
     */
    const onGlobalClick = (e) => {
      const btn = e.target.closest('.js-refresh-trigger');
      if (btn) {
        refresh(btn);
      }
    };

    // åˆå§‹åŒ–ç›‘å¬
    document.addEventListener('click', onGlobalClick);

    // å¤„ç† Astro ViewTransitions å¯¼è‡´çš„é¡µé¢æ›¿æ¢
    document.addEventListener('astro:after-swap', () => {
      // ç§»é™¤æ—§ç›‘å¬é˜²æ­¢ç´¯åŠ ï¼Œé‡æ–°æ·»åŠ ä»¥ç¡®ä¿æ–° DOM ç”Ÿæ•ˆ
      document.removeEventListener('click', onGlobalClick);
      document.addEventListener('click', onGlobalClick);
    });
  })();
</script>