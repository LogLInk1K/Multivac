<script is:inline>
  // --- 1. 立即执行函数：防止首屏闪烁 & 路由跳转闪烁 ---
  function applyTheme() {
    const theme = localStorage.getItem('theme') || 
      (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  // 初始执行
  applyTheme();

  // 关键：在 ClientRouter 交换新页面 DOM 后立即恢复主题类名，防止闪烁
  document.addEventListener('astro:after-swap', applyTheme);
</script>

<script>
  // --- 2. 交互逻辑：圆形扩散动画 ---
  async function toggleTheme(event: MouseEvent) {
    // 彻底切断事件链
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();

    const html = document.documentElement;
    html.classList.add('no-transitions');

    // 降级处理：不支持 View Transition 的浏览器
    if (!document.startViewTransition) {
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      html.classList.remove('no-transitions');
      return;
    }

    // 获取点击中心点，如果不是点击触发（如键盘）则取屏幕中心
    const x = event.clientX ?? window.innerWidth / 2;
    const y = event.clientY ?? window.innerHeight / 2;
    const endRadius = Math.hypot(
      Math.max(x, window.innerWidth - x),
      Math.max(y, window.innerHeight - y)
    );

    // 执行视图过渡
    const transition = document.startViewTransition(() => {
      const isDark = html.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    try {
      await transition.ready;
      const isEnteringDark = html.classList.contains('dark');
      
      // 动画配置
      html.animate(
        {
          clipPath: isEnteringDark 
            ? [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`]
            : [`circle(${endRadius}px at ${x}px ${y}px)`, `circle(0px at ${x}px ${y}px)`],
        },
        {
          duration: 450,
          easing: 'ease-in-out',
          fill: 'forwards',
          // 根据亮暗决定是在旧层还是新层上做裁剪
          pseudoElement: isEnteringDark ? '::view-transition-new(root)' : '::view-transition-old(root)',
        }
      );
      await transition.finished;
    } finally {
      // 动画结束后移除屏蔽类
      html.classList.remove('no-transitions');
    }
  }

  function init() {
    const btn = document.querySelector('#theme-toggle-btn');
    if (btn) {
      // 先移除再添加，彻底解决 ClientRouter 模式下重复绑定的问题
      btn.removeEventListener('click', toggleTheme as any); 
      btn.addEventListener('click', toggleTheme as any);
    }
  }

  // 适配 ClientRouter 生命周期：初始加载 + 路由切换
  init();
  document.addEventListener('astro:page-load', init);
</script>

<button
  id="theme-toggle-btn"
  type="button"
  class="-mr-2 group relative p-2 text-text-light hover:text-primary-light dark:text-text-dark dark:hover:text-primary-dark transition-colors focus:outline-none z-[60] pointer-events-auto"
  aria-label="Toggle dark mode"
>
  <svg class="w-6 h-6 dark:hidden transition-all duration-300 group-hover:scale-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
  </svg>
  <svg class="w-6 h-6 hidden dark:block transition-all duration-300 group-hover:scale-75" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
  <div class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 group-hover:opacity-100 group-hover:scale-100">
    <div class="bg-primary-light dark:bg-primary-dark rounded-full px-1 py-1">
      <svg class="w-6 h-6 text-white dark:text-black dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
      <svg class="w-6 h-6 text-white dark:text-black hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    </div>
  </div>
</button>