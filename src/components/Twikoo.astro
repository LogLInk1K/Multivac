---
interface Props {
	elId?: string;
}

const { elId: customElId } = Astro.props;
const envId = 'https://twikoo.1k.ink';

const pageKey = (() => {
	try {
		return Astro.url.pathname || '/';
	} catch {
		return '/';
	}
})();

const elId = customElId ?? `tcomment-${pageKey.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'root'}`;
---
<div id={elId} class="twikoo" data-twikoo-env-id={envId}></div>

<script is:inline data-astro-rerun>
	var TWIKOO_SRC = 'https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.nocss.js';

	function getTwikooMounts() {
		return Array.from(document.querySelectorAll('.twikoo[data-twikoo-env-id]'));
	}

	function waitForTwikooGlobal(timeoutMs = 3000) {
		const start = performance.now();
		return new Promise((resolve, reject) => {
			const tick = () => {
				if (window.twikoo && typeof window.twikoo.init === 'function') return resolve();
				if (performance.now() - start > timeoutMs) return reject(new Error('twikoo global timeout'));
				requestAnimationFrame(tick);
			};
			tick();
		});
	}

	function waitForTwikooCssLink(timeoutMs = 3000) {
		const link = document.head.querySelector('link[rel="stylesheet"][href*="twikoo-base.css"]');
		if (!link) return Promise.resolve();
		if (link.sheet) return Promise.resolve();

		return new Promise((resolve) => {
			const timer = setTimeout(resolve, timeoutMs);
			const done = () => {
				clearTimeout(timer);
				resolve();
			};
			link.addEventListener('load', done, { once: true });
			link.addEventListener('error', done, { once: true });
		});
	}

	function ensureTwikooLoaded() {
		if (window.twikoo && typeof window.twikoo.init === 'function') return Promise.resolve();
		window.__twikooLoader = window.__twikooLoader || { promise: null };
		if (window.__twikooLoader.promise) return window.__twikooLoader.promise;

		window.__twikooLoader.promise = new Promise((resolve, reject) => {
			const existing = document.getElementById('twikoo-script');
			if (existing) {
				existing.setAttribute('data-astro-transition-persist', '');
				if (window.twikoo && typeof window.twikoo.init === 'function') return resolve();

				existing.addEventListener(
					'load',
					() => {
						resolve();
					},
					{ once: true },
				);
				existing.addEventListener('error', reject, { once: true });
				return;
			}

			const script = document.createElement('script');
			script.id = 'twikoo-script';
			script.src = TWIKOO_SRC;
			script.async = true;
			script.setAttribute('data-astro-transition-persist', '');
			script.onload = () => resolve();
			script.onerror = (e) => {
				window.__twikooLoader.promise = null;
				reject(e);
			};
			document.head.appendChild(script);
		});

		return window.__twikooLoader.promise.then(() => waitForTwikooGlobal());
	}

	function initTwikooForMount(mountEl) {
		if (!window.twikoo || typeof window.twikoo.init !== 'function') return;

		if (!mountEl || !(mountEl instanceof Element)) return;
		const envId = mountEl.getAttribute('data-twikoo-env-id');
		if (!envId) return;
		if (!mountEl.id) return;

		mountEl.innerHTML = '';

		window.twikoo.init({
			envId,
			el: `#${mountEl.id}`,
			lang: 'zh-CN',
			path: window.location.pathname,
		});
	}

	function boot() {
		const mounts = getTwikooMounts();
		if (!mounts.length) return;

		// 检查是否已经初始化过，避免重复初始化
		const initializedMounts = new Set();
		document.querySelectorAll('.twikoo[data-twikoo-env-id]').forEach(el => {
			if (el.children.length > 0) { // 已经初始化过（有内容）
				initializedMounts.add(el.id);
			}
		});

		const init = () => {
			waitForTwikooCssLink()
				.then(() => ensureTwikooLoaded())
				.then(() => {
					requestAnimationFrame(() =>
						requestAnimationFrame(() => {
							for (const m of mounts) {
								// 只初始化未初始化的实例
								if (!initializedMounts.has(m.id)) {
									initTwikooForMount(m);
								}
							}
						}),
					);
				})
				.catch(() => {
					// ignore
				});
		};

		// 使用 requestIdleCallback 延迟初始化（如果浏览器支持）
		if ('requestIdleCallback' in window) {
			window.requestIdleCallback(() => init(), { timeout: 2000 });
		} else {
			// 降级方案：使用延迟的 setTimeout
			setTimeout(init, 100);
		}
	}

	// 防止重复监听
	if (!window.__twikooAstro) {
		window.__twikooAstro = { listeners: false };

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', boot, { once: true });
		} else {
			boot();
		}
		document.addEventListener('astro:page-load', boot);
		document.addEventListener('astro:after-swap', boot);
		window.__twikooAstro.listeners = true;
	}
</script>
