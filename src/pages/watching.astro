---
import MainLayout from '../layouts/MainLayout.astro';
import LeftSidebar from '../components/LeftSidebar.astro';
import RightSidebar from '../components/RightSidebar.astro';
import { getEntry } from 'astro:content';

interface Rating {
  source: 'douban' | 'bangumi';
  score: number;
}

interface Link {
  source: 'douban' | 'bangumi';
  url: string;
}

interface WatchingItem {
  title: string;
  year: number;
  cover: string;
  comment: string;
  type: string;
  ratings?: Rating[];
  links?: Link[];
}

const defaultWatching: WatchingItem[] = [
  {
    title: '虫师',
    year: 2005,
    cover: '/img/df-cover.webp',
    comment: '远山如雾',
    type: '动漫',
    ratings: [{ source: 'douban', score: 9.4 }],
    links: [{ source: 'douban', url: 'https://movie.douban.com/subject/1800597/' }],
  },
  {
    title: '无头骑士异闻录',
    year: 2010,
    cover: '/img/df-cover.webp',
    comment: '这里是池袋',
    type: '动漫',
    ratings: [{ source: 'douban', score: 8.8 }],
    links: [{ source: 'douban', url: 'https://movie.douban.com/subject/4291876/' }],
  },
];

let watchingList: WatchingItem[] = defaultWatching;
let pageTitle = '最近在看';
let pageDescription = '记录我正在看的影视、动漫、书籍等';
let pubDate: Date | undefined;

try {
  const watchingData = await getEntry('post', 'watching');
  if (watchingData && watchingData.data.watching) {
    watchingList = watchingData.data.watching as WatchingItem[];
    if (watchingData.data.title) pageTitle = watchingData.data.title;
    if (watchingData.data.description) pageDescription = watchingData.data.description;
    if (watchingData.data.pubDate) pubDate = watchingData.data.pubDate;
  }
} catch (error) {
  console.log('Using default watching data');
}

function formatDate(date: Date): string {
  return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
}

const ratingIcons: Record<string, string> = {
  douban: '/img/douban.ico',
  bangumi: '/img/bangumi.ico',
};

const ratingAlts: Record<string, string> = {
  douban: '豆瓣评分',
  bangumi: 'Bangumi评分',
};

function getLinkBySource(item: WatchingItem, source: string): string | undefined {
  return item.links?.find(link => link.source === source)?.url;
}
---

<MainLayout title={pageTitle} description={pageDescription}>
  <section class="max-w-[1340px] mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="grid grid-cols-1 md:grid-cols-[272px_1fr] gap-6">
      <div class="hidden md:block">
        <div class="space-y-6">
          <LeftSidebar />
          <div class="md:block">
            <RightSidebar />
          </div>
        </div>
      </div>

      <div>
        <div class="p-8 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 mb-6 border border-transparent hover:border-border-light dark:hover:border-border-dark">
          <h1 class="text-3xl font-bold text-text-light dark:text-text-dark mb-2">{pageTitle}</h1>
          <p class="text-text-light/70 dark:text-text-dark/70">
            {pageDescription}
          </p>
          <div class="flex items-center gap-2 mt-4 text-sm text-text-light/60 dark:text-text-dark/60">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
            </svg>
            <span>共 {watchingList.length} 部作品</span>
            {pubDate && (
                <span class="flex items-center">
                  <span class="mr-2">·</span>
                  始于 {formatDate(pubDate)}
                </span>
            )}
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {watchingList.map((item) => (
            <article class="group bg-card-light dark:bg-card-dark rounded-2xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 overflow-hidden border border-border-light/50 dark:border-border-dark/50 hover:border-border-light dark:hover:border-border-dark">
              <div class="relative aspect-[3/4] overflow-hidden bg-hover-light dark:bg-hover-dark rounded-t-2xl">
                <img
                  src={item.cover}
                  alt={item.title}
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500 will-change-transform"
                  loading="lazy"
                />
                {item.ratings && item.ratings.length > 0 && (
                  <div class="absolute top-4 right-4 flex gap-1">
                    {item.ratings.map((rating) => {
                      const link = getLinkBySource(item, rating.source);
                      return link ? (
                        <a
                          href={link}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="px-2 py-1 rounded-lg bg-black/40 backdrop-blur-sm flex items-center gap-1 hover:bg-black/80 transition-colors cursor-pointer"
                        >
                          <img src={ratingIcons[rating.source]} alt={ratingAlts[rating.source]} class="w-4 h-4" />
                          <span class="text-white text-sm font-medium">{rating.score.toFixed(1)}</span>
                        </a>
                      ) : (
                        <div class="px-2 py-1 rounded-lg bg-black/40 backdrop-blur-sm flex items-center gap-1">
                          <img src={ratingIcons[rating.source]} alt={ratingAlts[rating.source]} class="w-4 h-4" />
                          <span class="text-white text-sm font-medium">{rating.score.toFixed(1)}</span>
                        </div>
                      );
                    })}
                  </div>
                )}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-4 pt-12">
                  <h3 class="text-white font-bold text-xl line-clamp-1 mb-1.5">{item.title}</h3>
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs px-1.5 py-0.5 rounded bg-white/20 text-white">{item.type}</span>
                    <span class="text-white/60 text-xs">{item.year}</span>
                  </div>
                  <div class="relative pl-3 pr-2 py-2 rounded-lg bg-white/10 backdrop-blur-sm border-white/70">
                    <p class="text-white text-sm line-clamp-3 leading-relaxed font-medium">
                      <svg class="w-4 h-4 text-white/50 inline-block mr-1 align-text-bottom" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"></path>
                      </svg>
                      {item.comment}
                    </p>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>

        {watchingList.length === 0 && (
          <div class="p-12 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-text-light/40 dark:text-text-dark/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
            </svg>
            <p class="text-text-light/60 dark:text-text-dark/60">
              暂无记录
            </p>
          </div>
        )}
      </div>
    </div>
  </section>
</MainLayout>
