---
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import LeftSidebar from '../../components/LeftSidebar.astro';
import RightSidebar from '../../components/RightSidebar.astro';
import ArchiveItem from '../../components/ArchiveItem.astro';
import { SITE_DESCRIPTION } from '../../consts';

export async function getStaticPaths() {
  const posts = await getCollection('post', ({ data }) => !data.draft && !data.friends && !data.moments);
  const tags = new Set();
  
  posts.forEach(post => {
    const postTags = post.data.tags || [];
    postTags.forEach(tag => tags.add(tag));
  });
  
  return Array.from(tags).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const allPosts = await getCollection('post', ({ data }) => !data.draft && !data.friends && !data.moments);
const posts = allPosts.filter(post => {
	const tags = post.data.tags as string[] | undefined;
	return tags?.includes(tag as string);
}).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<MainLayout title={`标签: ${tag}`} description={SITE_DESCRIPTION}>
	<section class="max-w-[1340px] mx-auto px-4 sm:px-6 lg:px-8 py-16">
			<!-- 响应式布局：小屏幕单列，中等及大屏幕双栏 -->
			<div class="grid grid-cols-1 md:grid-cols-[272px_1fr] gap-6">
				<!-- 左侧边栏：中等及大屏幕显示 -->
				<div class="hidden md:block">
					<div class="space-y-6">
						<LeftSidebar />
						<!-- 中等及大屏幕：右侧边栏显示在左侧边栏下方 -->
						<div class="md:block">
							<RightSidebar />
						</div>
					</div>
				</div>

				<!-- 中间内容区：所有屏幕显示 -->
				<div>
					<div class="p-6 bg-card-light dark:bg-card-dark rounded-3xl shadow-sm hover:-translate-y-1 hover:shadow-xl transition-all duration-300 border border-transparent hover:border-border-light dark:hover:border-border-dark">
						{posts.map((post) => (
							<ArchiveItem key={post.id} post={post} />
						))}
					</div>
				</div>
			</div>
	</section>
</MainLayout>
